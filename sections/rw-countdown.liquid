{%- assign parts = sec_id | split: '_' -%}
{%- assign last_lower = parts | last -%}
{%- assign last_part = last_lower | downcase -%}

{%- capture countdown_date -%}
  {%- if section.settings.date != blank -%}
    {{ section.settings.date | date: "%b %d %Y %H:%M:%S" }}
  {%- else -%}
    Jan 01 2026 00:00:00
  {%- endif -%}
{%- endcapture -%}

<pc-countdown-blocks-{{ last_part }} class="pc-countdown-blocks-{{ last_part }}">
  {%- if section.settings.show_circle -%}
    <div class="pc-circle-{{ last_part }}"></div>
  {%- endif -%}
  
  {%- if section.settings.show_cursor -%}
    <div class="pc-cursor-{{ last_part }}"></div>
  {%- endif -%}
  
  <div class="pc-countdown-container-{{ last_part }}">
    {%- for block in section.blocks -%}
      {%- case block.type -%}
        {%- when 'days_block' -%}
          <div class="pc-countdown-block-{{ last_part }} pc-days-block-{{ last_part }}" {{ block.shopify_attributes }}>
            <div class="pc-countdown-value-{{ last_part }}" id="pc-days-{{ last_part }}">DD</div>
            <div class="pc-countdown-label-{{ last_part }}">{{ block.settings.label | default: 'DAYS' }}</div>
          </div>
        
        {%- when 'hours_block' -%}
          <div class="pc-countdown-block-{{ last_part }} pc-hours-block-{{ last_part }}" {{ block.shopify_attributes }}>
            <div class="pc-countdown-value-{{ last_part }}" id="pc-hours-{{ last_part }}">HH</div>
            <div class="pc-countdown-label-{{ last_part }}">{{ block.settings.label | default: 'HOURS' }}</div>
          </div>
        
        {%- when 'minutes_block' -%}
          <div class="pc-countdown-block-{{ last_part }} pc-minutes-block-{{ last_part }}" {{ block.shopify_attributes }}>
            <div class="pc-countdown-value-{{ last_part }}" id="pc-minutes-{{ last_part }}">MM</div>
            <div class="pc-countdown-label-{{ last_part }}">{{ block.settings.label | default: 'MINUTES' }}</div>
          </div>
        
        {%- when 'seconds_block' -%}
          <div class="pc-countdown-block-{{ last_part }} pc-seconds-block-{{ last_part }}" {{ block.shopify_attributes }}>
            <div class="pc-countdown-value-{{ last_part }}" id="pc-seconds-{{ last_part }}">SS</div>
            <div class="pc-countdown-label-{{ last_part }}">{{ block.settings.label | default: 'SECONDS' }}</div>
          </div>
        
        {%- when 'separator' -%}
          <div class="pc-countdown-separator-{{ last_part }}" {{ block.shopify_attributes }}>
            {{ block.settings.separator }}
          </div>
      {%- endcase -%}
    {%- endfor -%}
  </div>
</pc-countdown-blocks-{{ last_part }}>

<style>
  {{ sec_id }} .pc-countdown-blocks-{{ last_part }} {
    position: relative;
    width: 100%;
    overflow: hidden;
  }

  {{ sec_id }} .pc-countdown-container-{{ last_part }} {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    gap: {{ section.settings.blocks_gap }}px;
    padding: {{ section.settings.desktop_padding_top }}px {{ section.settings.desktop_padding_right }}px {{ section.settings.desktop_padding_bottom }}px {{ section.settings.desktop_padding_left }}px;
  }

  {{ sec_id }} .pc-countdown-block-{{ last_part }} {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: {{ section.settings.block_min_width }}px;
    height: {{ section.settings.block_height }}px;
    border-radius: {{ section.settings.block_border_radius }}px;
    {% if section.settings.block_shadow %}
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16);
    {% endif %}
    padding: {{ section.settings.block_padding }}px;
  }

  {{ sec_id }} .pc-days-block-{{ last_part }} {
    background: {{ section.settings.days_background }};
    color: {{ section.settings.days_text_color }};
  }

  {{ sec_id }} .pc-hours-block-{{ last_part }} {
    background: {{ section.settings.hours_background }};
    color: {{ section.settings.hours_text_color }};
  }

  {{ sec_id }} .pc-minutes-block-{{ last_part }} {
    background: {{ section.settings.minutes_background }};
    color: {{ section.settings.minutes_text_color }};
  }

  {{ sec_id }} .pc-seconds-block-{{ last_part }} {
    background: {{ section.settings.seconds_background }};
    color: {{ section.settings.seconds_text_color }};
  }

  {{ sec_id }} .pc-countdown-value-{{ last_part }} {
    font-size: {{ section.settings.time_value_size }}px;
    font-weight: {{ section.settings.time_value_weight }};
    line-height: 1;
  }

  {{ sec_id }} .pc-countdown-label-{{ last_part }} {
    font-size: {{ section.settings.time_label_size }}px;
    font-weight: {{ section.settings.time_label_weight }};
    margin-top: {{ section.settings.label_margin_top }}px;
  }

  {{ sec_id }} .pc-countdown-separator-{{ last_part }} {
    display: flex;
    align-items: center;
    font-size: {{ section.settings.time_value_size | times: 0.6 }}px;
    color: {{ section.settings.separator_color }};
    padding: 0 {{ section.settings.separator_padding }}px;
  }

  {{ sec_id }} .pc-circle-{{ last_part }} {
    position: fixed;
    z-index: -1;
    top: calc(50% - 237px);
    left: calc(-50% + 474px);
    width: 474px;
    height: 474px;
    border-radius: 100%;
    border: 6px dashed {{ section.settings.circle_color }};
    animation: pc-rotating-circle-{{ last_part }} infinite linear 60s;
  }

  @keyframes pc-rotating-circle-{{ last_part }} {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  {{ sec_id }} .pc-cursor-{{ last_part }} {
    position: fixed;
    top: 0;
    left: 0;
    background-color: transparent;
    transform: translate(-50%, -50%);
    width: 10px;
    height: 10px;
    border-radius: 100%;
    pointer-events: none;
    user-select: none;
    backdrop-filter: invert(100%);
  }

  @media (max-width: 768px) {
    {{ sec_id }} .pc-countdown-container-{{ last_part }} {
      padding: {{ section.settings.mobile_padding_top }}px {{ section.settings.mobile_padding_right }}px {{ section.settings.mobile_padding_bottom }}px {{ section.settings.mobile_padding_left }}px;
      gap: {{ section.settings.mobile_blocks_gap }}px;
    }

    {{ sec_id }} .pc-countdown-block-{{ last_part }} {
      min-width: {{ section.settings.mobile_block_min_width }}px;
      height: {{ section.settings.mobile_block_height }}px;
    }

    {{ sec_id }} .pc-countdown-value-{{ last_part }} {
      font-size: {{ section.settings.mobile_time_value_size }}px;
    }

    {{ sec_id }} .pc-countdown-label-{{ last_part }} {
      font-size: {{ section.settings.mobile_time_label_size }}px;
    }

    {{ sec_id }} .pc-countdown-separator-{{ last_part }} {
      font-size: {{ section.settings.mobile_time_value_size | times: 0.6 }}px;
    }

    {{ sec_id }} .pc-circle-{{ last_part }} {
      display: {{ section.settings.show_circle_mobile | json }};
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Countdown functionality
    const daysEl = document.querySelector("#pc-days-{{ last_part }}");
    const hoursEl = document.querySelector("#pc-hours-{{ last_part }}");
    const minutesEl = document.querySelector("#pc-minutes-{{ last_part }}");
    const secondsEl = document.querySelector("#pc-seconds-{{ last_part }}");
    
    const countdownDate = new Date("{{ countdown_date | strip }}").getTime();
    
    function updateCountdown() {
      const now = new Date().getTime();
      const distance = countdownDate - now;
      
      const days = Math.floor(distance / (1000 * 60 * 60 * 24));
      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);
      
      if (daysEl) daysEl.textContent = formatTime(days);
      if (hoursEl) hoursEl.textContent = formatTime(hours);
      if (minutesEl) minutesEl.textContent = formatTime(minutes);
      if (secondsEl) secondsEl.textContent = formatTime(seconds);
    }
    
    function formatTime(time) {
      return time < 10 ? `0${time}` : time;
    }
    
    updateCountdown();
    setInterval(updateCountdown, 1000);
    
    // Cursor trail functionality
    {% if section.settings.show_cursor %}
    const cursorEl = document.querySelector(".pc-cursor-{{ last_part }}");
    
    document.addEventListener("mousemove", (ev) => {
      const x = ev.clientX;
      const y = ev.clientY;
      
      let animationFrame;
      let startX = parseFloat(cursorEl.style.left) || 0;
      let startY = parseFloat(cursorEl.style.top) || 0;
      let progress = 0;
      
      const animateCursor = () => {
        progress += 0.05;
        if (progress >= 1) progress = 1;
        
        const currentX = startX + (x - startX) * progress;
        const currentY = startY + (y - startY) * progress;
        
        cursorEl.style.left = `${currentX}px`;
        cursorEl.style.top = `${currentY}px`;
        
        if (progress < 1) {
          animationFrame = requestAnimationFrame(animateCursor);
        }
      };
      
      cancelAnimationFrame(animationFrame);
      animateCursor();
    });
    {% endif %}
  });
</script>

{% schema %}
{
  "name": "PWC - Countdown Blocks #1",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Countdown Settings"
    },
    {
      "type": "text",
      "id": "date",
      "label": "Countdown End Date",
      "info": "Format: MM/DD/YYYY HH:MM (e.g., 01/01/2026 00:00)",
      "default": "01/01/2026 00:00"
    },
    {
      "type": "range",
      "id": "blocks_gap",
      "label": "Blocks Gap",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 10
    },
    {
      "type": "range",
      "id": "block_min_width",
      "label": "Block Min Width",
      "min": 50,
      "max": 300,
      "step": 10,
      "unit": "px",
      "default": 120
    },
    {
      "type": "range",
      "id": "block_height",
      "label": "Block Height",
      "min": 50,
      "max": 300,
      "step": 10,
      "unit": "px",
      "default": 120
    },
    {
      "type": "range",
      "id": "block_border_radius",
      "label": "Block Border Radius",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 12
    },
    {
      "type": "range",
      "id": "block_padding",
      "label": "Block Padding",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 10
    },
    {
      "type": "checkbox",
      "id": "block_shadow",
      "label": "Enable Block Shadow",
      "default": true
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "days_background",
      "label": "Days Background",
      "default": "#00A3D0"
    },
    {
      "type": "color",
      "id": "days_text_color",
      "label": "Days Text Color",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "hours_background",
      "label": "Hours Background",
      "default": "#00A3D0"
    },
    {
      "type": "color",
      "id": "hours_text_color",
      "label": "Hours Text Color",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "minutes_background",
      "label": "Minutes Background",
      "default": "#1C1C1C"
    },
    {
      "type": "color",
      "id": "minutes_text_color",
      "label": "Minutes Text Color",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "seconds_background",
      "label": "Seconds Background",
      "default": "#1C1C1C"
    },
    {
      "type": "color",
      "id": "seconds_text_color",
      "label": "Seconds Text Color",
      "default": "#FFFFFF"
    },
    {
      "type": "color",
      "id": "separator_color",
      "label": "Separator Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "circle_color",
      "label": "Circle Color",
      "default": "#00A3D0"
    },
    {
      "type": "header",
      "content": "Typography"
    },
    {
      "type": "range",
      "id": "time_value_size",
      "label": "Time Value Size (Desktop)",
      "min": 20,
      "max": 100,
      "step": 2,
      "unit": "px",
      "default": 44
    },
    {
      "type": "select",
      "id": "time_value_weight",
      "label": "Time Value Weight",
      "options": [
        {
          "value": "400",
          "label": "Normal"
        },
        {
          "value": "700",
          "label": "Bold"
        }
      ],
      "default": "400"
    },
    {
      "type": "range",
      "id": "time_label_size",
      "label": "Time Label Size (Desktop)",
      "min": 12,
      "max": 40,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
      "type": "select",
      "id": "time_label_weight",
      "label": "Time Label Weight",
      "options": [
        {
          "value": "400",
          "label": "Normal"
        },
        {
          "value": "700",
          "label": "Bold"
        }
      ],
      "default": "400"
    },
    {
      "type": "range",
      "id": "label_margin_top",
      "label": "Label Margin Top",
      "min": 0,
      "max": 30,
      "step": 1,
      "unit": "px",
      "default": 5
    },
    {
      "type": "range",
      "id": "separator_padding",
      "label": "Separator Padding",
      "min": 0,
      "max": 30,
      "step": 1,
      "unit": "px",
      "default": 5
    },
    {
      "type": "header",
      "content": "Spacing (Desktop)"
    },
    {
      "type": "range",
      "id": "desktop_padding_top",
      "label": "Top Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "desktop_padding_right",
      "label": "Right Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "desktop_padding_bottom",
      "label": "Bottom Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "desktop_padding_left",
      "label": "Left Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 20
    },
    {
      "type": "header",
      "content": "Mobile Settings"
    },
    {
      "type": "range",
      "id": "mobile_blocks_gap",
      "label": "Blocks Gap (Mobile)",
      "min": 0,
      "max": 30,
      "step": 1,
      "unit": "px",
      "default": 5
    },
    {
      "type": "range",
      "id": "mobile_block_min_width",
      "label": "Block Min Width (Mobile)",
      "min": 40,
      "max": 200,
      "step": 10,
      "unit": "px",
      "default": 80
    },
    {
      "type": "range",
      "id": "mobile_block_height",
      "label": "Block Height (Mobile)",
      "min": 40,
      "max": 200,
      "step": 10,
      "unit": "px",
      "default": 80
    },
    {
      "type": "range",
      "id": "mobile_time_value_size",
      "label": "Time Value Size (Mobile)",
      "min": 16,
      "max": 60,
      "step": 2,
      "unit": "px",
      "default": 32
    },
    {
      "type": "range",
      "id": "mobile_time_label_size",
      "label": "Time Label Size (Mobile)",
      "min": 10,
      "max": 30,
      "step": 1,
      "unit": "px",
      "default": 14
    },
    {
      "type": "range",
      "id": "mobile_padding_top",
      "label": "Top Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "mobile_padding_right",
      "label": "Right Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 10
    },
    {
      "type": "range",
      "id": "mobile_padding_bottom",
      "label": "Bottom Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "mobile_padding_left",
      "label": "Left Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 10
    },
    {
      "type": "header",
      "content": "Effects"
    },
    {
      "type": "checkbox",
      "id": "show_circle",
      "label": "Show Rotating Circle",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_circle_mobile",
      "label": "Show Circle on Mobile",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_cursor",
      "label": "Show Mouse Trail",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "days_block",
      "name": "Days Block",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "label",
          "label": "Custom Label",
          "default": "DAYS",
          "info": "Leave empty to use default"
        }
      ]
    },
    {
      "type": "hours_block",
      "name": "Hours Block",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "label",
          "label": "Custom Label",
          "default": "HOURS",
          "info": "Leave empty to use default"
        }
      ]
    },
    {
      "type": "minutes_block",
      "name": "Minutes Block",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "label",
          "label": "Custom Label",
          "default": "MINUTES",
          "info": "Leave empty to use default"
        }
      ]
    },
    {
      "type": "seconds_block",
      "name": "Seconds Block",
      "limit": 1,
      "settings": [
        {
          "type": "text",
          "id": "label",
          "label": "Custom Label",
          "default": "SECONDS",
          "info": "Leave empty to use default"
        }
      ]
    },
    {
      "type": "separator",
      "name": "Separator",
      "limit": 3,
      "settings": [
        {
          "type": "text",
          "id": "separator",
          "label": "Separator Text",
          "default": ":",
          "info": "Can be any character or text"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "PWC - Countdown Blocks #1",
      "blocks": [
        {
          "type": "days_block"
        },
        {
          "type": "separator"
        },
        {
          "type": "hours_block"
        },
        {
          "type": "separator"
        },
        {
          "type": "minutes_block"
        },
        {
          "type": "separator"
        },
        {
          "type": "seconds_block"
        }
      ]
    }
  ]
}
{% endschema %}