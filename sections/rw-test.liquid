
{% style %}
  .fancy-testimonial-slider {
    font-family: 'Inter', sans-serif;
    background-color: {{ section.settings.bg_color }};
    position: relative;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    overflow: hidden;
  }

  .fancy-testimonial-slider .container {
    width: 100%;
    max-width: 84rem;
    margin-left: auto;
    margin-right: auto;
    padding: 6rem 1rem;
  }

  .fancy-testimonial-slider .slider-container {
    width: 100%;
    max-width: 48rem;
    margin-left: auto;
    margin-right: auto;
    text-align: center;
  }

  .fancy-testimonial-slider .image-container {
    position: relative;
    height: 8rem;
  }

  .fancy-testimonial-slider .image-wrapper {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 30rem;
    height: 30rem;
    pointer-events: none;
  }

  .fancy-testimonial-slider .image-wrapper::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, {{ section.settings.primary_color | color_modify: 'alpha', 0.25 }} 0%, {{ section.settings.primary_color | color_modify: 'alpha', 0.05 }} 25%, {{ section.settings.primary_color | color_modify: 'alpha', 0 }} 75%);
    border-radius: 9999px;
    z-index: -10;
  }

  .fancy-testimonial-slider .image-mask {
    height: 8rem;
    mask-image: linear-gradient(0deg, transparent, white 20%, white);
  }

  .fancy-testimonial-slider .testimonial-image {
    position: relative;
    top: 2.75rem;
    left: 50%;
    transform: translateX(-50%);
    border-radius: 9999px;
    width: 3.5rem;
    height: 3.5rem;
  }

  .fancy-testimonial-slider .text-container {
    margin-bottom: 2.25rem;
  }

  .fancy-testimonial-slider .text-wrapper {
    position: relative;
    display: flex;
    flex-direction: column;
    transition-property: all;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 150ms;
    transition-delay: 300ms;
  }

  .fancy-testimonial-slider .quote-text {
    font-size: 1.5rem;
    line-height: 2rem;
    font-weight: 700;
    color: {{ section.settings.text_color }};
  }

  .fancy-testimonial-slider .quote-text::before {
    content: '\201C';
  }

  .fancy-testimonial-slider .quote-text::after {
    content: '\201D';
  }

  .fancy-testimonial-slider .buttons-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    margin: -0.375rem;
  }

  .fancy-testimonial-slider .testimonial-button {
    display: inline-flex;
    justify-content: center;
    white-space: nowrap;
    border-radius: 9999px;
    padding: 0.375rem 0.75rem;
    margin: 0.375rem;
    font-size: 0.75rem;
    line-height: 1rem;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 150ms;
  }

  .fancy-testimonial-slider .testimonial-button.active {
    background-color: {{ section.settings.primary_color }};
    color: white;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.1);
  }

  .fancy-testimonial-slider .testimonial-button:not(.active) {
    background-color: white;
    color: {{ section.settings.text_color }};
  }

  .fancy-testimonial-slider .testimonial-button:not(.active):hover {
    background-color: {{ section.settings.primary_color | color_modify: 'alpha', 0.1 }};
  }

  .fancy-testimonial-slider .divider {
    color: {{ section.settings.primary_color | color_modify: 'alpha', 0.2 }};
  }

  .fancy-testimonial-slider .active .divider {
    color: {{ section.settings.primary_color | color_modify: 'alpha', 0.2 }};
  }

  /* Transitions */
  .fancy-testimonial-slider .image-transition-enter {
    transition-timing-function: cubic-bezier(0.68, -0.3, 0.32, 1);
    transition-duration: 700ms;
    order: -9999;
  }

  .fancy-testimonial-slider .image-transition-enter-start {
    opacity: 0;
    transform: rotate(-60deg);
  }

  .fancy-testimonial-slider .image-transition-enter-end {
    opacity: 1;
    transform: rotate(0);
  }

  .fancy-testimonial-slider .image-transition-leave {
    transition-timing-function: cubic-bezier(0.68, -0.3, 0.32, 1);
    transition-duration: 700ms;
  }

  .fancy-testimonial-slider .image-transition-leave-start {
    opacity: 1;
    transform: rotate(0);
  }

  .fancy-testimonial-slider .image-transition-leave-end {
    opacity: 0;
    transform: rotate(60deg);
  }

  .fancy-testimonial-slider .text-transition-enter {
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 500ms;
    transition-delay: 200ms;
    order: -9999;
  }

  .fancy-testimonial-slider .text-transition-enter-start {
    opacity: 0;
    transform: translateX(-1rem);
  }

  .fancy-testimonial-slider .text-transition-enter-end {
    opacity: 1;
    transform: translateX(0);
  }

  .fancy-testimonial-slider .text-transition-leave {
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 300ms;
    transition-delay: 300ms;
    position: absolute;
  }

  .fancy-testimonial-slider .text-transition-leave-start {
    opacity: 1;
    transform: translateX(0);
  }

  .fancy-testimonial-slider .text-transition-leave-end {
    opacity: 0;
    transform: translateX(1rem);
  }

  /* Footer */
  .fancy-testimonial-slider .footer {
    position: absolute;
    left: 1.5rem;
    right: 1.5rem;
    bottom: 1rem;
    text-align: center;
  }

  .fancy-testimonial-slider .footer-link {
    font-size: 0.75rem;
    line-height: 1rem;
    color: #64748b;
  }

  .fancy-testimonial-slider .footer-link:hover {
    text-decoration: underline;
  }

  @media (min-width: 768px) {
    .fancy-testimonial-slider .container {
      padding: 6rem 1.5rem;
    }

    .fancy-testimonial-slider .footer {
      left: 3rem;
      right: auto;
      bottom: 2rem;
      text-align: left;
    }
  }
{% endstyle %}

{% javascript %}
document.addEventListener('DOMContentLoaded', function() {
  class FancyTestimonialSlider {
    constructor(sectionId) {
      this.section = document.getElementById(sectionId);
      if (!this.section) return;

      this.autorotate = {{ section.settings.autorotate | json }};
      this.rotationSpeed = {{ section.settings.rotation_speed | json }};
      this.testimonials = [];
      this.activeIndex = 0;
      this.rotationInterval = null;
      this.init();
    }

    init() {
      // Get testimonials from blocks
      const testimonialBlocks = this.section.querySelectorAll('[data-testimonial]');
      this.testimonials = Array.from(testimonialBlocks).map(block => ({
        element: block,
        image: block.querySelector('[data-testimonial-image]'),
        quote: block.querySelector('[data-testimonial-quote]'),
        button: block.querySelector('[data-testimonial-button]')
      }));

      if (this.testimonials.length === 0) return;

      // Set initial active testimonial
      this.setActiveTestimonial(0);

      // Start auto rotation if enabled
      if (this.autorotate && this.testimonials.length > 1) {
        this.startAutorotation();
      }

      // Add event listeners to buttons
      this.testimonials.forEach((testimonial, index) => {
        if (testimonial.button) {
          testimonial.button.addEventListener('click', () => {
            this.setActiveTestimonial(index);
            this.stopAutorotation();
          });
        }
      });
    }

    setActiveTestimonial(index) {
      if (index < 0 || index >= this.testimonials.length) return;

      // Update active index
      this.activeIndex = index;

      // Update classes for all testimonials
      this.testimonials.forEach((testimonial, i) => {
        if (i === index) {
          testimonial.element.classList.add('active');
          if (testimonial.button) testimonial.button.classList.add('active');
        } else {
          testimonial.element.classList.remove('active');
          if (testimonial.button) testimonial.button.classList.remove('active');
        }
      });

      // Trigger height adjustment
      this.adjustHeight();
    }

    adjustHeight() {
      const activeTestimonial = this.testimonials[this.activeIndex];
      if (!activeTestimonial) return;

      const textWrapper = this.section.querySelector('[data-text-wrapper]');
      if (textWrapper) {
        textWrapper.style.height = `${activeTestimonial.quote.offsetHeight}px`;
      }
    }

    startAutorotation() {
      if (this.rotationInterval) clearInterval(this.rotationInterval);
      
      this.rotationInterval = setInterval(() => {
        this.activeIndex = (this.activeIndex + 1) % this.testimonials.length;
        this.setActiveTestimonial(this.activeIndex);
      }, this.rotationSpeed);
    }

    stopAutorotation() {
      if (this.rotationInterval) {
        clearInterval(this.rotationInterval);
        this.rotationInterval = null;
      }
    }
  }

  // Initialize slider for each section on the page
  document.querySelectorAll('.fancy-testimonial-slider').forEach((section, index) => {
    new FancyTestimonialSlider(section.id || `fancy-testimonial-${index}`);
  });
});
{% endjavascript %}

<div id="{{ section.id }}" class="fancy-testimonial-slider">
  <div class="container">
    {% if section.settings.heading != blank %}
      <h1 class="text-center text-3xl font-bold mb-12" style="color: {{ section.settings.text_color }};">
        {{ section.settings.heading }}
      </h1>
    {% endif %}

    <div class="slider-container">
      <!-- Testimonial image -->
      <div class="image-container">
        <div class="image-wrapper">
          <div class="image-mask">
            {% for block in section.blocks %}
              {% if block.type == 'testimonial' %}
                <div 
                  data-testimonial="{{ forloop.index0 }}"
                  class="absolute inset-0 -z-10 {% if forloop.first %}active{% else %}hidden{% endif %}"
                >
                  {% if block.settings.image != blank %}
                    <img 
                      data-testimonial-image
                      class="testimonial-image"
                      src="{{ block.settings.image | img_url: '112x112' }}"
                      width="56"
                      height="56"
                      alt="{{ block.settings.name }}"
                      loading="lazy"
                    >
                  {% else %}
                    <div class="testimonial-image bg-gray-200 flex items-center justify-center">
                      <span class="text-gray-500 text-xl">{{ block.settings.name | slice: 0 | upcase }}</span>
                    </div>
                  {% endif %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Text -->
      <div class="text-container">
        <div class="text-wrapper" data-text-wrapper>
          {% for block in section.blocks %}
            {% if block.type == 'testimonial' %}
              <div 
                data-testimonial="{{ forloop.index0 }}"
                class="{% if forloop.first %}active{% else %}hidden{% endif %}"
              >
                <div class="quote-text" data-testimonial-quote>
                  {{ block.settings.quote }}
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>

      <!-- Buttons -->
      <div class="buttons-container">
        {% for block in section.blocks %}
          {% if block.type == 'testimonial' %}
            <button 
              data-testimonial-button
              data-testimonial="{{ forloop.index0 }}"
              class="testimonial-button {% if forloop.first %}active{% endif %}"
            >
              <span>{{ block.settings.name }}</span>
              <span class="divider px-1">-</span>
              <span>{{ block.settings.role }}</span>
            </button>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <a class="footer-link" href="https://shopify.com" target="_blank" rel="noopener">&copy; {{ shop.name }}</a>
  </footer>
</div>

{% schema %}
{
  "name": "Fancy Testimonial Slider",
  "class": "fancy-testimonial-slider",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Section Heading",
      "default": "Testimonials"
    },
    {
      "type": "checkbox",
      "id": "autorotate",
      "label": "Enable Auto Rotation",
      "default": true
    },
    {
      "type": "range",
      "id": "rotation_speed",
      "label": "Rotation Speed (ms)",
      "min": 100,
      "max": 1000,
      "step": 10,
      "default": 100
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Primary Color",
      "default": "#6366f1"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#111827"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#f8fafc"
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Profile Image"
        },
        {
          "type": "text",
          "id": "quote",
          "label": "Testimonial Quote",
          "default": "The ability to capture responses is a game-changer."
        },
        {
          "type": "text",
          "id": "name",
          "label": "Name",
          "default": "Jessie J"
        },
        {
          "type": "text",
          "id": "role",
          "label": "Role/Company",
          "default": "Acme LTD"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Fancy Testimonial Slider",
      "category": "Testimonials",
      "blocks": [
        {
          "type": "testimonial",
          "settings": {
            "quote": "The ability to capture responses is a game-changer. If a user gets tired of the sign up and leaves, that data is still persisted.",
            "name": "Jessie J",
            "role": "Acme LTD"
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "quote": "Having the power to capture user feedback is revolutionary. Even if a participant abandons the sign-up process midway, their valuable input remains intact.",
            "name": "Nick V",
            "role": "Malika Inc."
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "quote": "The functionality to capture responses is a true game-changer. Even if a user becomes fatigued during sign-up and abandons the process, their information remains stored.",
            "name": "Amelia W",
            "role": "Panda AI"
          }
        }
      ]
    }
  ]
}
{% endschema %}
