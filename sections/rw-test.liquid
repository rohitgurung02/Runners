{%- assign sec_id = '#shopify-section-' | append: section.id -%}
{%- assign parts = sec_id | split: '_' -%}
{%- assign last_lower = parts | last -%}
{%- assign last_part = last_lower | downcase -%}

<style>
  {{ sec_id }} {
    --pc-bg-color-{{ last_part }}: {{ section.settings.bg_color }};
    --pc-card-width-{{ last_part }}: {{ section.settings.card_width }}px;
    --pc-card-height-{{ last_part }}: {{ section.settings.card_height }}px;
    --pc-black-{{ last_part }}: {{ section.settings.text_color }};
    --pc-white-{{ last_part }}: {{ section.settings.card_bg_color }};
    --pc-accent-{{ last_part }}: {{ section.settings.accent_color }};
    --pc-grid-color-{{ last_part }}: {{ section.settings.grid_color }};
    --pc-frame-color-{{ last_part }}: {{ section.settings.frame_color }};
  }

  {{ sec_id }} .pc-card-carousel-{{ last_part }} {
    position: relative;
    width: 100%;
    padding: {{ section.settings.section_padding_top }}px {{ section.settings.section_padding_right }}px {{ section.settings.section_padding_bottom }}px {{ section.settings.section_padding_left }}px;
    background-color: var(--pc-bg-color-{{ last_part }});
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    font-feature-settings: "salt" 1, "ss01" 1, "ss02" 1;
    color: var(--pc-black-{{ last_part }});
    overflow-x: hidden;
  }

  {{ sec_id }} .pc-carousel-{{ last_part }} {
    position: relative;
    width: 100%;
    max-width: {{ section.settings.max_width }}px;
    margin: 0 auto;
    padding: {{ section.settings.carousel_padding_top }}px 0 {{ section.settings.carousel_padding_bottom }}px 0;
  }

  {{ sec_id }} .pc-carousel-track-{{ last_part }} {
    display: flex;
    transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    padding: 40px 0;
    gap: {{ section.settings.card_gap }}px;
  }

  {{ sec_id }} .pc-deconstructed-card-{{ last_part }} {
    position: relative;
    width: var(--pc-card-width-{{ last_part }});
    height: var(--pc-card-height-{{ last_part }});
    cursor: pointer;
    transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    transform-style: preserve-3d;
    flex-shrink: 0;
  }

  {{ sec_id }} .pc-card-layer-{{ last_part }} {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    transition: transform 0.8s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.8s cubic-bezier(0.16, 1, 0.3, 1);
  }

  {{ sec_id }} .pc-card-image-{{ last_part }} {
    overflow: hidden;
    z-index: 1;
  }

  {{ sec_id }} .pc-card-bg-image-{{ last_part }} {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 1.2s cubic-bezier(0.16, 1, 0.3, 1);
  }

  {{ sec_id }} .pc-card-frame-{{ last_part }} {
    z-index: 3;
    pointer-events: none;
  }

  {{ sec_id }} .pc-frame-path-{{ last_part }} {
    fill: none;
    stroke: var(--pc-frame-color-{{ last_part }});
    stroke-width: 1;
    stroke-dasharray: 1520;
    stroke-dashoffset: 1520;
    transition: stroke-dashoffset 1.5s cubic-bezier(0.16, 1, 0.3, 1);
  }

  {{ sec_id }} .pc-card-background-{{ last_part }} {
    z-index: 0;
    background-color: var(--pc-white-{{ last_part }});
  }

  {{ sec_id }} .pc-bg-grid-{{ last_part }} {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  {{ sec_id }} .pc-grid-line-{{ last_part }} {
    position: absolute;
    background-color: var(--pc-grid-color-{{ last_part }});
    transition: transform 0.8s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }

  {{ sec_id }} .pc-horizontal-{{ last_part }} {
    width: 100%;
    height: 1px;
    transform: scaleX(0.3);
    transform-origin: left;
  }

  {{ sec_id }} .pc-vertical-{{ last_part }} {
    height: 100%;
    width: 1px;
    transform: scaleY(0.3);
    transform-origin: top;
  }

  {{ sec_id }} .pc-bg-objects-{{ last_part }} {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }

  {{ sec_id }} .pc-bg-object-{{ last_part }} {
    position: absolute;
    opacity: 0.3;
    transition: transform 0.8s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.8s cubic-bezier(0.16, 1, 0.3, 1);
  }

  {{ sec_id }} .pc-circle-{{ last_part }} {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 1px solid rgba(0, 0, 0, 0.1);
    bottom: 40px;
    left: -30px;
    transform: translateY(20px);
  }

  {{ sec_id }} .pc-square-{{ last_part }} {
    width: 60px;
    height: 60px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    top: 40px;
    right: 30px;
    transform: rotate(45deg) translateY(-20px);
  }

  {{ sec_id }} .pc-triangle-{{ last_part }} {
    width: 0;
    height: 0;
    border-left: 40px solid transparent;
    border-right: 40px solid transparent;
    border-bottom: 70px solid rgba(0, 0, 0, 0.05);
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.5);
  }

  {{ sec_id }} .pc-card-content-{{ last_part }} {
    z-index: 2;
    padding: 30px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 100%;
  }

  {{ sec_id }} .pc-content-fragment-{{ last_part }} {
    position: relative;
  }

  {{ sec_id }} .pc-fragment-heading-{{ last_part }} {
    margin-top: auto;
    margin-bottom: 1.5rem;
  }

  {{ sec_id }} .pc-content-text-{{ last_part }} {
    font-size: {{ section.settings.heading_font_size }}px;
    font-weight: {{ section.settings.heading_font_weight }};
    line-height: 1.2;
    letter-spacing: -0.02em;
    color: var(--pc-black-{{ last_part }});
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    transform: translateY(10px);
    opacity: 0.7;
  }

  {{ sec_id }} .pc-content-subtext-{{ last_part }} {
    font-size: {{ section.settings.subheading_font_size }}px;
    font-weight: 500;
    letter-spacing: 0.05em;
    margin-top: 1rem;
    color: var(--pc-black-{{ last_part }});
    opacity: 0.5;
    transform: translateY(10px);
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }

  {{ sec_id }} .pc-fragment-meta-{{ last_part }} {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 2rem;
  }

  {{ sec_id }} .pc-meta-line-{{ last_part }} {
    width: 40px;
    height: 1px;
    background-color: var(--pc-black-{{ last_part }});
    transform: scaleX(0.5);
    transform-origin: left;
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }

  {{ sec_id }} .pc-meta-text-{{ last_part }} {
    font-family: monospace;
    font-size: {{ section.settings.meta_font_size }}px;
    letter-spacing: 0.05em;
    opacity: 0.6;
    transform: translateX(-5px);
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }

  {{ sec_id }} .pc-fragment-body-{{ last_part }} {
    max-width: 85%;
    margin: 1.5rem 0;
  }

  {{ sec_id }} .pc-fragment-body-{{ last_part }} .pc-content-text-{{ last_part }} {
    font-size: {{ section.settings.body_font_size }}px;
    font-weight: 400;
    line-height: 1.5;
    letter-spacing: normal;
    opacity: 0.6;
  }

  {{ sec_id }} .pc-fragment-cta-{{ last_part }} {
    margin-top: auto;
    overflow: visible;
  }

  {{ sec_id }} .pc-cta-link-{{ last_part }} {
    text-decoration: none;
    position: relative;
    display: inline-flex;
    align-items: center;
    padding: 8px 0;
  }

  {{ sec_id }} .pc-cta-box-{{ last_part }} {
    position: absolute;
    top: 0;
    left: -10px;
    width: calc(100% + 20px);
    height: 100%;
    background-color: var(--pc-black-{{ last_part }});
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }

  {{ sec_id }} .pc-cta-text-{{ last_part }} {
    position: relative;
    font-family: monospace;
    font-size: {{ section.settings.cta_font_size }}px;
    font-weight: 700;
    letter-spacing: 0.1em;
    color: var(--pc-black-{{ last_part }});
    transition: color 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    transform: translateX(-5px);
    opacity: 0.7;
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s cubic-bezier(0.16, 1, 0.3, 1), color 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }

  {{ sec_id }} .pc-text-align-right-{{ last_part }} {
    align-self: flex-end;
    text-align: right;
  }

  {{ sec_id }} .pc-text-align-right-{{ last_part }} .pc-meta-line-{{ last_part }} {
    transform-origin: right;
  }

  {{ sec_id }} .pc-text-align-right-{{ last_part }} .pc-cta-box-{{ last_part }} {
    transform-origin: right;
  }

  {{ sec_id }} .pc-text-align-right-{{ last_part }} .pc-meta-text-{{ last_part }} {
    transform: translateX(5px);
  }

  {{ sec_id }} .pc-align-right-{{ last_part }} {
    text-align: right;
  }

  {{ sec_id }} .pc-deconstructed-card-{{ last_part }}:hover .pc-frame-path-{{ last_part }} {
    stroke-dashoffset: 0;
  }

  {{ sec_id }} .pc-deconstructed-card-{{ last_part }}:hover .pc-content-text-{{ last_part }},
  {{ sec_id }} .pc-deconstructed-card-{{ last_part }}:hover .pc-content-subtext-{{ last_part }} {
    transform: translateY(0);
    opacity: 1;
    transition-delay: 0.05s;
  }

  {{ sec_id }} .pc-deconstructed-card-{{ last_part }}:hover .pc-fragment-body-{{ last_part }} .pc-content-text-{{ last_part }} {
    transition-delay: 0.1s;
    opacity: 1;
  }

  {{ sec_id }} .pc-deconstructed-card-{{ last_part }}:hover .pc-meta-text-{{ last_part }} {
    transform: translateX(0);
    opacity: 1;
    transition-delay: 0.15s;
  }

  {{ sec_id }} .pc-deconstructed-card-{{ last_part }}:hover .pc-meta-line-{{ last_part }} {
    transform: scaleX(1);
    transition-delay: 0.05s;
  }

  {{ sec_id }} .pc-deconstructed-card-{{ last_part }}:hover .pc-card-bg-image-{{ last_part }} {
    transform: scale(1.05);
  }

  {{ sec_id }} .pc-deconstructed-card-{{ last_part }}:hover .pc-cta-text-{{ last_part }} {
    transform: translateX(0);
    opacity: 1;
    transition-delay: 0.2s;
  }

  {{ sec_id }} .pc-deconstructed-card-{{ last_part }}:hover .pc-cta-link-{{ last_part }}:hover .pc-cta-box-{{ last_part }} {
    transform: scaleX(1);
  }

  {{ sec_id }} .pc-deconstructed-card-{{ last_part }}:hover .pc-cta-link-{{ last_part }}:hover .pc-cta-text-{{ last_part }} {
    color: var(--pc-white-{{ last_part }});
  }

  {{ sec_id }} .pc-text-card-{{ last_part }}:hover .pc-horizontal-{{ last_part }} {
    transform: scaleX(1);
  }

  {{ sec_id }} .pc-text-card-{{ last_part }}:hover .pc-vertical-{{ last_part }} {
    transform: scaleY(1);
  }

  {{ sec_id }} .pc-text-card-{{ last_part }}:hover .pc-bg-object-{{ last_part }} {
    opacity: 1;
    transform: translate(0, 0) rotate(0);
  }

  {{ sec_id }} .pc-text-card-{{ last_part }}:hover .pc-square-{{ last_part }} {
    transform: rotate(45deg) translate(0, 0);
  }

  {{ sec_id }} .pc-text-card-{{ last_part }}:hover .pc-triangle-{{ last_part }} {
    transform: translate(-50%, -50%) scale(1);
  }

  {{ sec_id }} .pc-carousel-controls-{{ last_part }} {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 30px;
  }

  {{ sec_id }} .pc-carousel-button-{{ last_part }} {
    background: var(--pc-black-{{ last_part }});
    color: var(--pc-white-{{ last_part }});
    border: none;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }

  {{ sec_id }} .pc-carousel-button-{{ last_part }}:hover {
    transform: translateY(-2px);
  }

  {{ sec_id }} .pc-carousel-button-{{ last_part }}:active {
    transform: translateY(0);
  }

  {{ sec_id }} .pc-carousel-button-{{ last_part }} svg {
    width: 24px;
    height: 24px;
  }

  {{ sec_id }} .pc-dots-container-{{ last_part }} {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 20px;
  }

  {{ sec_id }} .pc-dot-{{ last_part }} {
    width: 8px;
    height: 8px;
    background-color: var(--pc-black-{{ last_part }});
    border-radius: 50%;
    opacity: 0.3;
    transition: transform 0.3s ease, opacity 0.3s ease;
    cursor: pointer;
  }

  {{ sec_id }} .pc-dot-{{ last_part }}.pc-active-{{ last_part }} {
    opacity: 1;
    transform: scale(1.3);
  }

  @media (max-width: 768px) {
    {{ sec_id }} .pc-card-carousel-{{ last_part }} {
      padding: {{ section.settings.mobile_section_padding_top }}px {{ section.settings.mobile_section_padding_right }}px {{ section.settings.mobile_section_padding_bottom }}px {{ section.settings.mobile_section_padding_left }}px;
    }

    {{ sec_id }} {
      --pc-card-width-{{ last_part }}: {{ section.settings.mobile_card_width }}px;
      --pc-card-height-{{ last_part }}: {{ section.settings.mobile_card_height }}px;
    }

    {{ sec_id }} .pc-card-content-{{ last_part }} {
      padding: 20px;
    }

    {{ sec_id }} .pc-content-text-{{ last_part }} {
      font-size: {{ section.settings.mobile_heading_font_size }}px;
    }

    {{ sec_id }} .pc-carousel-track-{{ last_part }} {
      gap: {{ section.settings.mobile_card_gap }}px;
    }
  }
</style>

<pc-card-carousel-{{ last_part }} class="pc-card-carousel-{{ last_part }}">
  <div class="pc-carousel-{{ last_part }}">
    <div class="pc-carousel-track-{{ last_part }}">
      {%- for block in section.blocks -%}
        <article class="pc-deconstructed-card-{{ last_part }} {% if block.settings.card_type == 'text' %}pc-text-card-{{ last_part }}{% endif %}">
          
          {%- if block.settings.card_type == 'image' -%}
            <div class="pc-card-layer-{{ last_part }} pc-card-image-{{ last_part }}">
              {%- if block.settings.background_image != blank -%}
                {% assign image_class = 'pc-card-bg-image-' | append: last_part %}
                {{ 
                  block.settings.background_image 
                  | image_url: width: 600 
                  | image_tag: 
                      loading: 'lazy', 
                      class: image_class,
                      alt: block.settings.heading 
                }}
              {%- else -%}
  {{ 'product-1' | placeholder_svg_tag: 'pc-placeholder-svg' }}
{%- endif -%}
            </div>
          {%- else -%}
            <div class="pc-card-layer-{{ last_part }} pc-card-background-{{ last_part }}">
              <div class="pc-bg-grid-{{ last_part }}">
                <div class="pc-grid-line-{{ last_part }} pc-horizontal-{{ last_part }}" style="top: 25%"></div>
                <div class="pc-grid-line-{{ last_part }} pc-horizontal-{{ last_part }}" style="top: 50%"></div>
                <div class="pc-grid-line-{{ last_part }} pc-horizontal-{{ last_part }}" style="top: 75%"></div>
                <div class="pc-grid-line-{{ last_part }} pc-vertical-{{ last_part }}" style="left: 33.33%"></div>
                <div class="pc-grid-line-{{ last_part }} pc-vertical-{{ last_part }}" style="left: 66.66%"></div>
              </div>
              <div class="pc-bg-objects-{{ last_part }}">
                <div class="pc-bg-object-{{ last_part }} pc-circle-{{ last_part }}"></div>
                <div class="pc-bg-object-{{ last_part }} pc-square-{{ last_part }}"></div>
                <div class="pc-bg-object-{{ last_part }} pc-triangle-{{ last_part }}"></div>
              </div>
            </div>
          {%- endif -%}
          
          <div class="pc-card-layer-{{ last_part }} pc-card-frame-{{ last_part }}">
            <svg viewBox="0 0 300 400" preserveAspectRatio="none">
              <path class="pc-frame-path-{{ last_part }}" d="M 20,20 H 280 V 380 H 20 Z" />
            </svg>
          </div>
          
          <div class="pc-card-layer-{{ last_part }} pc-card-content-{{ last_part }} {% if block.settings.content_alignment == 'right' %}pc-text-align-right-{{ last_part }}{% endif %}">
            <div class="pc-content-fragment-{{ last_part }} pc-fragment-heading-{{ last_part }}">
              <h2 class="pc-content-text-{{ last_part }} {% if block.settings.content_alignment == 'right' %}pc-align-right-{{ last_part }}{% endif %}">{{ block.settings.heading }}</h2>
              <h3 class="pc-content-subtext-{{ last_part }} {% if block.settings.content_alignment == 'right' %}pc-align-right-{{ last_part }}{% endif %}">{{ block.settings.subheading }}</h3>
            </div>
            
            <div class="pc-content-fragment-{{ last_part }} pc-fragment-meta-{{ last_part }} {% if block.settings.content_alignment == 'right' %}pc-text-align-right-{{ last_part }}{% endif %}">
              {% if block.settings.content_alignment != 'right' %}<div class="pc-meta-line-{{ last_part }}"></div>{% endif %}
              <span class="pc-meta-text-{{ last_part }}">{{ block.settings.category }}</span>
              {% if block.settings.content_alignment == 'right' %}<div class="pc-meta-line-{{ last_part }}"></div>{% endif %}
            </div>
            
            <div class="pc-content-fragment-{{ last_part }} pc-fragment-body-{{ last_part }} {% if block.settings.content_alignment == 'right' %}pc-text-align-right-{{ last_part }}{% endif %}">
              <p class="pc-content-text-{{ last_part }}">{{ block.settings.description }}</p>
            </div>
            
            <div class="pc-content-fragment-{{ last_part }} pc-fragment-cta-{{ last_part }} {% if block.settings.content_alignment == 'right' %}pc-text-align-right-{{ last_part }}{% endif %}">
              <a href="{{ block.settings.link_url }}" class="pc-cta-link-{{ last_part }}" target="{{ block.settings.link_target }}">
                <div class="pc-cta-box-{{ last_part }}"></div>
                <span class="pc-cta-text-{{ last_part }}">{{ block.settings.link_text }}</span>
              </a>
            </div>
          </div>
        </article>
      {%- endfor -%}
    </div>

    <div class="pc-carousel-controls-{{ last_part }}">
      <button class="pc-carousel-button-{{ last_part }} pc-prev-{{ last_part }}">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
      <button class="pc-carousel-button-{{ last_part }} pc-next-{{ last_part }}">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
    </div>

    <div class="pc-dots-container-{{ last_part }}"></div>
  </div>
</pc-card-carousel-{{ last_part }}>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const sectionId = "{{ sec_id }}";
  const lastPart = "{{ last_part }}";
  
  const track = document.querySelector(`${sectionId} .pc-carousel-track-${lastPart}`);
  const cards = document.querySelectorAll(`${sectionId} .pc-deconstructed-card-${lastPart}`);
  const prevBtn = document.querySelector(`${sectionId} .pc-prev-${lastPart}`);
  const nextBtn = document.querySelector(`${sectionId} .pc-next-${lastPart}`);
  const dotsContainer = document.querySelector(`${sectionId} .pc-dots-container-${lastPart}`);

  if (!track || !cards.length) return;

  // Clone first and last cards for seamless looping
  const firstCardClone = cards[0].cloneNode(true);
  const lastCardClone = cards[cards.length - 1].cloneNode(true);
  
  track.appendChild(firstCardClone);
  track.insertBefore(lastCardClone, cards[0]);
  
  // Update cards reference after cloning
  const allCards = document.querySelectorAll(`${sectionId} .pc-deconstructed-card-${lastPart}`);
  const totalCards = allCards.length;
  
  // Set initial position to show the first actual card (not the clone)
  let currentIndex = 1;
  track.style.transform = `translateX(-${currentIndex * (allCards[0].offsetWidth + {{ section.settings.card_gap }})}px)`;

  // Create dots for the original cards only
  for (let i = 0; i < cards.length; i++) {
    const dot = document.createElement("div");
    dot.classList.add(`pc-dot-${lastPart}`);
    if (i === 0) dot.classList.add(`pc-active-${lastPart}`);
    dot.addEventListener("click", () => goToCard(i + 1)); // +1 because we added a clone at the beginning
    dotsContainer.appendChild(dot);
  }

  const dots = document.querySelectorAll(`${sectionId} .pc-dot-${lastPart}`);
  
  // Set up card interactions
  allCards.forEach((card) => {
    card.addEventListener("mousemove", (e) => {
      const rect = card.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      const y = (e.clientY - rect.top) / rect.height;
      const xDeg = (y - 0.5) * 8;
      const yDeg = (x - 0.5) * -8;
      card.style.transform = `perspective(1200px) rotateX(${xDeg}deg) rotateY(${yDeg}deg)`;
      
      const layers = card.querySelectorAll(`.pc-card-layer-${lastPart}`);
      layers.forEach((layer, index) => {
        const depth = 30 * (index + 1);
        const translateZ = depth;
        const offsetX = (x - 0.5) * 10 * (index + 1);
        const offsetY = (y - 0.5) * 10 * (index + 1);
        layer.style.transform = `translate3d(${offsetX}px, ${offsetY}px, ${translateZ}px)`;
      });
      
      const bgImage = card.querySelector(`.pc-card-bg-image-${lastPart}`);
      if (bgImage) {
        const moveX = (x - 0.5) * -20;
        const moveY = (y - 0.5) * -20;
        bgImage.style.transform = `translate(${moveX}px, ${moveY}px) scale(1.05)`;
      }
      
      const bgObjects = card.querySelectorAll(`.pc-bg-object-${lastPart}`);
      bgObjects.forEach((obj, index) => {
        const factorX = (index + 1) * 10;
        const factorY = (index + 1) * 8;
        const moveX = (x - 0.5) * factorX;
        const moveY = (y - 0.5) * factorY;
        if (obj.classList.contains(`pc-square-${lastPart}`)) {
          obj.style.transform = `rotate(45deg) translate(${moveX}px, ${moveY}px)`;
        } else if (obj.classList.contains(`pc-triangle-${lastPart}`)) {
          obj.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px)) scale(1)`;
        } else {
          obj.style.transform = `translate(${moveX}px, ${moveY}px)`;
        }
      });
    });

    card.addEventListener("mouseleave", () => {
      card.style.transform = "";
      const layers = card.querySelectorAll(`.pc-card-layer-${lastPart}`);
      layers.forEach((layer) => {
        layer.style.transform = "";
      });
      
      const bgImage = card.querySelector(`.pc-card-bg-image-${lastPart}`);
      if (bgImage) {
        bgImage.style.transform = "";
      }
      
      const bgObjects = card.querySelectorAll(`.pc-bg-object-${lastPart}`);
      bgObjects.forEach((obj) => {
        if (obj.classList.contains(`pc-square-${lastPart}`)) {
          obj.style.transform = "rotate(45deg) translateY(-20px)";
        } else if (obj.classList.contains(`pc-triangle-${lastPart}`)) {
          obj.style.transform = "translate(-50%, -50%) scale(0.5)";
        } else {
          obj.style.transform = "translateY(20px)";
        }
      });
    });
  });

  function goToCard(index, animate = true) {
    if (animate) {
      track.style.transition = "transform 0.6s cubic-bezier(0.16, 1, 0.3, 1)";
    } else {
      track.style.transition = "none";
    }
    
    const cardWidth = allCards[0].offsetWidth;
    const cardMargin = {{ section.settings.card_gap }};
    const totalCardWidth = cardWidth + cardMargin;
    const translateX = -index * totalCardWidth;
    
    track.style.transform = `translateX(${translateX}px)`;
    
    // Update current index
    currentIndex = index;
    
    // Update dots for the original cards only
    let dotIndex = index - 1;
    if (dotIndex < 0) dotIndex = cards.length - 1;
    if (dotIndex >= cards.length) dotIndex = 0;
    
    dots.forEach((dot, i) => {
      dot.classList.toggle(`pc-active-${lastPart}`, i === dotIndex);
    });
  }

  function handleCarouselTransition() {
    // If we're at the beginning (clone of last card), jump to the real last card
    if (currentIndex === 0) {
      goToCard(cards.length, false);
    }
    // If we're at the end (clone of first card), jump to the real first card
    else if (currentIndex === totalCards - 1) {
      goToCard(1, false);
    }
  }

  // Listen for transition end to handle the seamless looping
  track.addEventListener('transitionend', handleCarouselTransition);

  if (prevBtn) {
    prevBtn.addEventListener("click", () => {
      goToCard(currentIndex - 1);
    });
  }

  if (nextBtn) {
    nextBtn.addEventListener("click", () => {
      goToCard(currentIndex + 1);
    });
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "ArrowLeft") {
      goToCard(currentIndex - 1);
    } else if (e.key === "ArrowRight") {
      goToCard(currentIndex + 1);
    }
  });

  let touchStartX = 0;
  let touchEndX = 0;

  track.addEventListener("touchstart", (e) => {
    touchStartX = e.changedTouches[0].screenX;
  });

  track.addEventListener("touchend", (e) => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
  });

  function handleSwipe() {
    if (touchStartX - touchEndX > 50) {
      goToCard(currentIndex + 1);
    } else if (touchEndX - touchStartX > 50) {
      goToCard(currentIndex - 1);
    }
  }

  window.addEventListener("resize", () => {
    const newCardWidth = allCards[0].offsetWidth;
    const newTotalCardWidth = newCardWidth + {{ section.settings.card_gap }};

    const translateX = -currentIndex * newTotalCardWidth;
    track.style.transition = "none";
    track.style.transform = `translateX(${translateX}px)`;

    setTimeout(() => {
      track.style.transition = "transform 0.6s cubic-bezier(0.16, 1, 0.3, 1)";
    }, 50);
  });
});
</script>

{% schema %}
{
  "name": "PWC - Card Carousel #1",
  "class": "pc-card-carousel-section",
  "settings": [
    {
      "type": "header",
      "content": "General Settings"
    },
    {
      "type": "range",
      "id": "max_width",
      "label": "Max Container Width",
      "min": 800,
      "max": 1800,
      "step": 50,
      "unit": "px",
      "default": 1400
    },
    {
      "type": "range",
      "id": "card_width",
      "label": "Card Width",
      "min": 200,
      "max": 500,
      "step": 10,
      "unit": "px",
      "default": 300
    },
    {
      "type": "range",
      "id": "card_height",
      "label": "Card Height",
      "min": 300,
      "max": 600,
      "step": 20,
      "unit": "px",
      "default": 400
    },
    {
      "type": "range",
      "id": "card_gap",
      "label": "Card Gap",
      "min": 10,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 40
    },
    {
      "type": "header",
      "content": "Color Settings"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#f1f1f1"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#080808"
    },
    {
      "type": "color",
      "id": "card_bg_color",
      "label": "Card Background Color",
      "default": "#fafafa"
    },
    {
      "type": "color",
      "id": "accent_color",
      "label": "Accent Color",
      "default": "#ff2d55"
    },
    {
      "type": "color",
      "id": "grid_color",
      "label": "Grid Color",
      "default": "rgba(0, 0, 0, 0.08)"
    },
    {
      "type": "color",
      "id": "frame_color",
      "label": "Frame Color",
      "default": "rgba(8, 8, 8, 0.8)"
    },
    {
      "type": "header",
      "content": "Typography Settings"
    },
    {
      "type": "range",
      "id": "heading_font_size",
      "label": "Heading Font Size",
      "min": 16,
      "max": 48,
      "step": 2,
      "unit": "px",
      "default": 32
    },
    {
      "type": "select",
      "id": "heading_font_weight",
      "label": "Heading Font Weight",
      "options": [
        { "value": "300", "label": "Light" },
        { "value": "400", "label": "Regular" },
        { "value": "500", "label": "Medium" },
        { "value": "700", "label": "Bold" },
        { "value": "900", "label": "Black" }
      ],
      "default": "900"
    },
    {
      "type": "range",
      "id": "subheading_font_size",
      "label": "Subheading Font Size",
      "min": 12,
      "max": 24,
      "step": 1,
      "unit": "px",
      "default": 14
    },
    {
      "type": "range",
      "id": "meta_font_size",
      "label": "Meta Text Font Size",
      "min": 10,
      "max": 18,
      "step": 1,
      "unit": "px",
      "default": 12
    },
    {
      "type": "range",
      "id": "body_font_size",
      "label": "Body Text Font Size",
      "min": 12,
      "max": 20,
      "step": 1,
      "unit": "px",
      "default": 14
    },
    {
      "type": "range",
      "id": "cta_font_size",
      "label": "CTA Text Font Size",
      "min": 10,
      "max": 16,
      "step": 1,
      "unit": "px",
      "default": 12
    },
    {
      "type": "header",
      "content": "Desktop Spacing"
    },
    {
      "type": "range",
      "id": "section_padding_top",
      "label": "Section Top Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "section_padding_right",
      "label": "Section Right Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "section_padding_bottom",
      "label": "Section Bottom Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "section_padding_left",
      "label": "Section Left Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "carousel_padding_top",
      "label": "Carousel Top Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 5
    },
    {
      "type": "range",
      "id": "carousel_padding_bottom",
      "label": "Carousel Bottom Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 5
    },
    {
      "type": "header",
      "content": "Mobile Settings"
    },
    {
      "type": "range",
      "id": "mobile_card_width",
      "label": "Mobile Card Width",
      "min": 150,
      "max": 400,
      "step": 10,
      "unit": "px",
      "default": 280
    },
    {
      "type": "range",
      "id": "mobile_card_height",
      "label": "Mobile Card Height",
      "min": 250,
      "max": 500,
      "step": 10,
      "unit": "px",
      "default": 380
    },
    {
      "type": "range",
      "id": "mobile_card_gap",
      "label": "Mobile Card Gap",
      "min": 5,
      "max": 50,
      "step": 5,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "mobile_heading_font_size",
      "label": "Mobile Heading Font Size",
      "min": 14,
      "max": 36,
      "step": 2,
      "unit": "px",
      "default": 28
    },
    {
      "type": "range",
      "id": "mobile_section_padding_top",
      "label": "Mobile Section Top Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "mobile_section_padding_right",
      "label": "Mobile Section Right Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "mobile_section_padding_bottom",
      "label": "Mobile Section Bottom Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "mobile_section_padding_left",
      "label": "Mobile Section Left Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 20
    }
  ],
  "blocks": [
    {
      "type": "card",
      "name": "Card",
      "settings": [
        {
          "type": "select",
          "id": "card_type",
          "label": "Card Type",
          "options": [
            { "value": "image", "label": "Image Background" },
            { "value": "text", "label": "Text Background" }
          ],
          "default": "image"
        },
        {
          "type": "image_picker",
          "id": "background_image",
          "label": "Background Image",
          "info": "Only applies to image background cards"
        },
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "CARD HEADING"
        },
        {
          "type": "text",
          "id": "subheading",
          "label": "Subheading",
          "default": "Card subheading text"
        },
        {
          "type": "text",
          "id": "category",
          "label": "Category",
          "default": "CATEGORY"
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Description",
          "default": "Card description text goes here with more details about this card."
        },
        {
          "type": "text",
          "id": "link_text",
          "label": "Link Text",
          "default": "OPEN CALCULATOR"
        },
        {
          "type": "url",
          "id": "link_url",
          "label": "Link URL"
        },
        {
          "type": "select",
          "id": "link_target",
          "label": "Link Target",
          "options": [
            { "value": "_self", "label": "Same Window" },
            { "value": "_blank", "label": "New Window" }
          ],
          "default": "_blank"
        },
        {
          "type": "select",
          "id": "content_alignment",
          "label": "Content Alignment",
          "options": [
            { "value": "left", "label": "Left" },
            { "value": "right", "label": "Right" }
          ],
          "default": "left"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "PWC - Card Carousel #8",
      "category": "Custom",
      "blocks": [
        {
          "type": "card",
          "settings": {
            "card_type": "image",
            "heading": "PREGNANCY",
            "subheading": "DUE DATE CALCULATOR",
            "category": "HEALTH",
            "description": "Calculate your expected delivery date with precision based on your last period or conception date.",
            "link_text": "OPEN CALCULATOR"
          }
        },
        {
          "type": "card",
          "settings": {
            "card_type": "image",
            "heading": "BABY EYE",
            "subheading": "COLOR CALCULATOR",
            "category": "BIOLOGY",
            "description": "Predict possible eye colors for your baby based on parental genetics and inheritance patterns.",
            "link_text": "OPEN CALCULATOR"
          }
        },
        {
          "type": "card",
          "settings": {
            "card_type": "text",
            "heading": "PERCENTAGE",
            "subheading": "PRECISION CALCULATOR",
            "category": "MATH",
            "description": "Calculate percentages for discounts, taxes, tips, and any percentage-based math with ease and accuracy.",
            "link_text": "OPEN CALCULATOR",
            "content_alignment": "right"
          }
        }
      ]
    }
  ]
}
{% endschema %}