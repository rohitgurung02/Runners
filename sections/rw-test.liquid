{%- assign sec_id = '#shopify-section-' | append: section.id -%}
{%- assign parts = sec_id | split: '_' -%}
{%- assign last_lower = parts | last -%}
{%- assign last_part = last_lower | downcase -%}

<pc-gallery-{{ last_part }} class="pc-gallery">
  <div class="pc-gallery__container">
    {%- if section.settings.heading != blank -%}
      <h2 class="pc-gallery__heading">{{ section.settings.heading }}</h2>
    {%- endif -%}
    
    <div class="pc-gallery__carousel">
      {%- for block in section.blocks -%}
        <div class="pc-gallery__slide" {{ block.shopify_attributes }}>
          {%- if block.settings.image != blank -%}
            {{- block.settings.image
              | image_url: width: 800
              | image_tag: loading: 'lazy', alt: block.settings.image.alt, class: 'pc-gallery__image'
            -}}
          {%- else -%}
            {{ 'product-1' | placeholder_svg_tag: 'pc-gallery__image' }}
          {%- endif -%}
        </div>
      {%- endfor -%}
    </div>
    
    {%- if section.settings.caption != blank -%}
      <p class="pc-gallery__caption">{{ section.settings.caption }}</p>
    {%- endif -%}
  </div>
</pc-gallery-{{ last_part }}>

<style>
  {{ sec_id }} .pc-gallery {
    position: relative;
    width: 100%;
    padding: {{ section.settings.desktop_padding_top }}px {{ section.settings.desktop_padding_right }}px {{ section.settings.desktop_padding_bottom }}px {{ section.settings.desktop_padding_left }}px;
    margin: {{ section.settings.desktop_margin_top }}px {{ section.settings.desktop_margin_right }}px {{ section.settings.desktop_margin_bottom }}px {{ section.settings.desktop_margin_left }}px;
    background-color: {{ section.settings.background_color }};
    {%- if section.settings.shadow_enabled -%}
      box-shadow: 0 8px 30px -7px {{ section.settings.shadow_color | color_modify: 'alpha', 0.3 }};
    {%- endif -%}
  }

  {{ sec_id }} .pc-gallery__container {
    max-width: {{ section.settings.max_width }}px;
    margin: 0 auto;
    padding: 0 15px;
  }

  {{ sec_id }} .pc-gallery__heading {
    text-align: center;
    font-size: {{ section.settings.heading_font_size }}px;
    color: {{ section.settings.heading_color }};
    font-weight: {{ section.settings.heading_font_weight }};
    margin: 0 0 {{ section.settings.heading_margin_bottom }}px 0;
  }

  {{ sec_id }} .pc-gallery__carousel {
    display: flex;
    overflow: hidden;
    position: relative;
  }

  {{ sec_id }} .pc-gallery__slide {
    flex: 0 0 100%;
    min-width: 100%;
    padding: 0 10px;
    transition: all 0.3s ease;
  }

  {{ sec_id }} .pc-gallery__image {
    width: 100%;
    height: auto;
    object-fit: cover;
    border-radius: {{ section.settings.image_border_radius }}px;
    transform: scale(0.9);
    transition: transform 0.3s ease;
    {%- if section.settings.image_shadow_enabled -%}
      box-shadow: 0 4px 15px {{ section.settings.image_shadow_color | color_modify: 'alpha', 0.2 }};
    {%- endif -%}
  }

  {{ sec_id }} .pc-gallery__slide.active .pc-gallery__image {
    transform: scale(1);
  }

  {{ sec_id }} .pc-gallery__caption {
    text-align: center;
    font-size: {{ section.settings.caption_font_size }}px;
    color: {{ section.settings.caption_color }};
    margin: {{ section.settings.caption_margin_top }}px 0 0 0;
  }

  {{ sec_id }} .pc-gallery__dots {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 20px;
  }

  {{ sec_id }} .pc-gallery__dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: {{ section.settings.dot_color }};
    border: 2px solid {{ section.settings.dot_active_color }};
    cursor: pointer;
  }

  {{ sec_id }} .pc-gallery__dot.active {
    background: {{ section.settings.dot_active_color }};
  }

  {{ sec_id }} .pc-gallery__nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-top: 20px;
  }

  {{ sec_id }} .pc-gallery__arrow {
    background: transparent;
    border: none;
    cursor: pointer;
    color: {{ section.settings.arrow_color }};
    padding: 5px;
  }

  @media (min-width: 768px) {
    {{ sec_id }} .pc-gallery__slide {
      flex: 0 0 50%;
      min-width: 50%;
    }
  }

  @media (min-width: 1024px) {
    {{ sec_id }} .pc-gallery__slide {
      flex: 0 0 33.333%;
      min-width: 33.333%;
    }
  }

  @media (max-width: 767px) {
    {{ sec_id }} .pc-gallery {
      padding: {{ section.settings.mobile_padding_top }}px {{ section.settings.mobile_padding_right }}px {{ section.settings.mobile_padding_bottom }}px {{ section.settings.mobile_padding_left }}px;
      margin: {{ section.settings.mobile_margin_top }}px {{ section.settings.mobile_margin_right }}px {{ section.settings.mobile_margin_bottom }}px {{ section.settings.mobile_margin_left }}px;
    }

    {{ sec_id }} .pc-gallery__heading {
      font-size: {{ section.settings.heading_font_size_mobile }}px;
      margin-bottom: {{ section.settings.heading_margin_bottom_mobile }}px;
    }

    {{ sec_id }} .pc-gallery__image {
      transform: none;
    }

    {{ sec_id }} .pc-gallery__slide.active .pc-gallery__image {
      transform: none;
    }

    {{ sec_id }} .pc-gallery__caption {
      font-size: {{ section.settings.caption_font_size_mobile }}px;
    }
  }
</style>

<script>
  class PcGallery{{ last_part | capitalize }} extends HTMLElement {
    constructor() {
      super();
      this.carousel = this.querySelector('.pc-gallery__carousel');
      this.slides = this.querySelectorAll('.pc-gallery__slide');
      this.prevBtn = this.querySelector('.pc-gallery__arrow--prev');
      this.nextBtn = this.querySelector('.pc-gallery__arrow--next');
      this.dotsContainer = this.querySelector('.pc-gallery__dots');
      this.dots = [];
      this.currentIndex = 0;
      this.slideCount = this.slides.length;
      this.autoSlideInterval = null;
      this.autoSlideDelay = {{ section.settings.auto_slide_delay | default: 5000 }};
      this.isAnimating = false;
      
      this.init();
    }
    
    init() {
      this.setupSlides();
      this.createDots();
      this.setupEventListeners();
      this.goToSlide(this.currentIndex);
      
      if ({{ section.settings.auto_rotate }}) {
        this.startAutoSlide();
      }

      this.setupResizeObserver();
    }

    setupSlides() {
      // Clone first and last slides for infinite looping
      const firstClone = this.slides[0].cloneNode(true);
      const lastClone = this.slides[this.slides.length - 1].cloneNode(true);
      
      firstClone.classList.add('clone');
      lastClone.classList.add('clone');
      
      this.carousel.appendChild(firstClone);
      this.carousel.insertBefore(lastClone, this.carousel.firstChild);
      
      // Update slides reference
      this.slides = this.querySelectorAll('.pc-gallery__slide');
      this.slideCount = this.slides.length;
      
      // Set initial position
      this.carousel.style.transform = `translateX(-${100}%)`;
    }
    
    createDots() {
      // Only create dots for original slides (excluding clones)
      const originalSlideCount = this.slideCount - 2;
      
      for (let i = 0; i < originalSlideCount; i++) {
        const dot = document.createElement('div');
        dot.classList.add('pc-gallery__dot');
        dot.dataset.index = i;
        this.dotsContainer.appendChild(dot);
        this.dots.push(dot);
      }
    }
    
    setupEventListeners() {
      if (this.prevBtn) {
        this.prevBtn.addEventListener('click', () => this.prevSlide());
      }
      
      if (this.nextBtn) {
        this.nextBtn.addEventListener('click', () => this.nextSlide());
      }
      
      this.dots.forEach(dot => {
        dot.addEventListener('click', () => {
          const index = parseInt(dot.dataset.index);
          this.goToSlide(index);
        });
      });
    }

    setupResizeObserver() {
      const resizeObserver = new ResizeObserver(entries => {
        this.updateCarouselPosition();
      });
      resizeObserver.observe(this.carousel);
    }
    
    goToSlide(index) {
      if (this.isAnimating) return;
      
      this.isAnimating = true;
      this.currentIndex = index + 1; // +1 because of the cloned slide at start
      
      this.carousel.style.transition = 'transform 0.5s ease';
      this.carousel.style.transform = `translateX(-${this.currentIndex * 100}%)`;
      
      this.updateActiveState();
      
      setTimeout(() => {
        this.isAnimating = false;
      }, 500);
    }
    
    updateCarouselPosition() {
      this.carousel.style.transition = 'none';
      this.carousel.style.transform = `translateX(-${this.currentIndex * 100}%)`;
      
      // Force reflow
      this.carousel.offsetHeight;
      
      this.carousel.style.transition = 'transform 0.5s ease';
    }
    
    updateActiveState() {
      // Update dots
      const activeDotIndex = (this.currentIndex - 1 + (this.slideCount - 2)) % (this.slideCount - 2);
      this.dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === activeDotIndex);
      });
      
      // Update slide active state
      this.slides.forEach((slide, index) => {
        if (index === this.currentIndex) {
          slide.classList.add('active');
        } else {
          slide.classList.remove('active');
        }
      });
    }
    
    prevSlide() {
      if (this.isAnimating) return;
      
      this.currentIndex--;
      if (this.currentIndex < 0) {
        this.currentIndex = this.slideCount - 1;
        this.updateCarouselPosition();
      }
      
      this.carousel.style.transition = 'transform 0.5s ease';
      this.carousel.style.transform = `translateX(-${this.currentIndex * 100}%)`;
      
      this.updateActiveState();
      this.resetAutoSlide();
    }
    
    nextSlide() {
      if (this.isAnimating) return;
      
      this.currentIndex++;
      if (this.currentIndex >= this.slideCount) {
        this.currentIndex = 1;
        this.updateCarouselPosition();
      }
      
      this.carousel.style.transition = 'transform 0.5s ease';
      this.carousel.style.transform = `translateX(-${this.currentIndex * 100}%)`;
      
      this.updateActiveState();
      this.resetAutoSlide();
    }
    
    startAutoSlide() {
      this.autoSlideInterval = setInterval(() => {
        this.nextSlide();
      }, this.autoSlideDelay);
    }
    
    resetAutoSlide() {
      if (this.autoSlideInterval) {
        clearInterval(this.autoSlideInterval);
        this.startAutoSlide();
      }
    }

    handleTransitionEnd() {
      // Handle infinite loop when reaching cloned slides
      if (this.currentIndex === 0) {
        this.currentIndex = this.slideCount - 2;
        this.updateCarouselPosition();
      } else if (this.currentIndex === this.slideCount - 1) {
        this.currentIndex = 1;
        this.updateCarouselPosition();
      }
    }
  }
  
  customElements.define('pc-gallery-{{ last_part }}', PcGallery{{ last_part | capitalize }});
</script>

{% schema %}
{
  "name": "PWC - Gallery Carousel #1",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Content Settings"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Gallery"
    },
    {
      "type": "text",
      "id": "caption",
      "label": "Caption",
      "default": "Images used from https://imgur.com/"
    },
    {
      "type": "range",
      "id": "max_width",
      "label": "Max Width",
      "min": 800,
      "max": 1600,
      "step": 50,
      "unit": "px",
      "default": 1200
    },
    {
      "type": "header",
      "content": "Typography"
    },
    {
      "type": "range",
      "id": "heading_font_size",
      "label": "Heading Font Size (Desktop)",
      "min": 12,
      "max": 72,
      "step": 1,
      "unit": "px",
      "default": 30
    },
    {
      "type": "range",
      "id": "heading_font_size_mobile",
      "label": "Heading Font Size (Mobile)",
      "min": 12,
      "max": 48,
      "step": 1,
      "unit": "px",
      "default": 24
    },
    {
      "type": "select",
      "id": "heading_font_weight",
      "label": "Heading Font Weight",
      "options": [
        {
          "value": "400",
          "label": "Normal"
        },
        {
          "value": "500",
          "label": "Medium"
        },
        {
          "value": "600",
          "label": "Semi Bold"
        },
        {
          "value": "700",
          "label": "Bold"
        }
      ],
      "default": "600"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#333333"
    },
    {
      "type": "range",
      "id": "heading_margin_bottom",
      "label": "Heading Margin Bottom",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 30
    },
    {
      "type": "range",
      "id": "heading_margin_bottom_mobile",
      "label": "Heading Margin Bottom (Mobile)",
      "min": 0,
      "max": 50,
      "step": 5,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "caption_font_size",
      "label": "Caption Font Size (Desktop)",
      "min": 12,
      "max": 24,
      "step": 1,
      "unit": "px",
      "default": 14
    },
    {
      "type": "range",
      "id": "caption_font_size_mobile",
      "label": "Caption Font Size (Mobile)",
      "min": 10,
      "max": 18,
      "step": 1,
      "unit": "px",
      "default": 12
    },
    {
      "type": "color",
      "id": "caption_color",
      "label": "Caption Color",
      "default": "#666666"
    },
    {
      "type": "range",
      "id": "caption_margin_top",
      "label": "Caption Margin Top",
      "min": 0,
      "max": 50,
      "step": 5,
      "unit": "px",
      "default": 20
    },
    {
      "type": "header",
      "content": "Image Settings"
    },
    {
      "type": "range",
      "id": "image_border_radius",
      "label": "Image Border Radius",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 10
    },
    {
      "type": "checkbox",
      "id": "image_shadow_enabled",
      "label": "Enable Image Shadow",
      "default": true
    },
    {
      "type": "color",
      "id": "image_shadow_color",
      "label": "Image Shadow Color",
      "default": "#000000"
    },
    {
      "type": "header",
      "content": "Carousel Settings"
    },
    {
      "type": "checkbox",
      "id": "auto_rotate",
      "label": "Auto Rotate Slides",
      "default": true
    },
    {
      "type": "range",
      "id": "auto_slide_delay",
      "label": "Auto Slide Delay (ms)",
      "min": 1000,
      "max": 9000,
      "step": 1000,
      "unit": "ms",
      "default": 1000
    },
    {
      "type": "color",
      "id": "dot_color",
      "label": "Dot Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "dot_active_color",
      "label": "Active Dot Color",
      "default": "#0970CF"
    },
    {
      "type": "color",
      "id": "arrow_color",
      "label": "Arrow Color",
      "default": "#0970CF"
    },
    {
      "type": "header",
      "content": "Section Design"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#ffffff"
    },
    {
      "type": "checkbox",
      "id": "shadow_enabled",
      "label": "Enable Section Shadow",
      "default": false
    },
    {
      "type": "color",
      "id": "shadow_color",
      "label": "Shadow Color",
      "default": "#000000"
    },
    {
      "type": "header",
      "content": "Desktop Spacing"
    },
    {
      "type": "range",
      "id": "desktop_padding_top",
      "label": "Top Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 40
    },
    {
      "type": "range",
      "id": "desktop_padding_right",
      "label": "Right Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "desktop_padding_bottom",
      "label": "Bottom Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 40
    },
    {
      "type": "range",
      "id": "desktop_padding_left",
      "label": "Left Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "desktop_margin_top",
      "label": "Top Margin",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "desktop_margin_right",
      "label": "Right Margin",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "desktop_margin_bottom",
      "label": "Bottom Margin",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "desktop_margin_left",
      "label": "Left Margin",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 0
    },
    {
      "type": "header",
      "content": "Mobile Spacing"
    },
    {
      "type": "range",
      "id": "mobile_padding_top",
      "label": "Top Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 30
    },
    {
      "type": "range",
      "id": "mobile_padding_right",
      "label": "Right Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 15
    },
    {
      "type": "range",
      "id": "mobile_padding_bottom",
      "label": "Bottom Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 30
    },
    {
      "type": "range",
      "id": "mobile_padding_left",
      "label": "Left Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 15
    },
    {
      "type": "range",
      "id": "mobile_margin_top",
      "label": "Top Margin",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "mobile_margin_right",
      "label": "Right Margin",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "mobile_margin_bottom",
      "label": "Bottom Margin",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "mobile_margin_left",
      "label": "Left Margin",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 0
    }
  ],
  "blocks": [
    {
      "type": "image",
      "name": "Image",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "PWC - Gallery Carousel #1",
      "blocks": [
        {
          "type": "image"
        },
        {
          "type": "image"
        },
        {
          "type": "image"
        },
        {
          "type": "image"
        }
      ]
    }
  ]
}
{% endschema %}