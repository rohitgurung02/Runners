{%- assign sec_id = '#shopify-section-' | append: section.id -%}
{%- assign parts = sec_id | split: '_' -%}
{%- assign last_lower = parts | last -%}
{%- assign last_part = last_lower | downcase -%}

<pc-testimonial-slider-{{ last_part }} class="pc-testimonial-slider">
  <div class="pc-testimonial-container">
    <div class="pc-testimonial-holder">
      <div class="pc-testimonial-image">
        {%- for block in section.blocks -%}
          <div class="pc-testimonial-img pc-img-{{ forloop.index }} {% if forloop.first %}active{% endif %}" 
               style="background: #fff {% if block.settings.image != blank %}url({{ block.settings.image | image_url: width: 800 }}){% else %}url({{ 'product-1' | placeholder_svg_tag }}){% endif %}; background-position: center; background-size: cover; background-repeat: no-repeat;">
          </div>
        {%- endfor -%}
      </div>
      
      <div class="pc-testimonial-right"></div>
      
      <div class="pc-testimonial-text">
        <div class="pc-testimonial-center-text">
          {%- for block in section.blocks -%}
            <div class="pc-testimonial-quote {% if forloop.first %}active{% endif %}">
              {{ block.settings.quote }}
            </div>
          {%- endfor -%}
        </div>

        <nav class="pc-testimonial-nav">
          <a class="pc-testimonial-prev">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
          </a>
          <a class="pc-testimonial-next">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
          </a>
        </nav>
      </div>
    </div>

    <div class="pc-testimonial-bg">
      {%- for block in section.blocks -%}
        <div class="pc-testimonial-slide pc-slide-{{ forloop.index }} {% if forloop.first %}active{% endif %}" 
             style="background: #fff {% if block.settings.background_image != blank %}url({{ block.settings.background_image | image_url: width: 2000 }}){% else %}url({{ 'product-1' | placeholder_svg_tag }}){% endif %}; background-size: cover; background-position: center; background-repeat: no-repeat;">
        </div>
      {%- endfor -%}
    </div>

    <div class="pc-testimonial-circles">
      {%- for block in section.blocks -%}
        <div class="pc-testimonial-circle {% if forloop.first %}active{% endif %}" data-index="{{ forloop.index0 }}"></div>
      {%- endfor -%}
    </div>
  </div>
</pc-testimonial-slider-{{ last_part }}>

<style>
  {{ sec_id }} .pc-testimonial-slider {
    width: 100%;
    min-height: 500px;
    height: 100vh;
    position: relative;
    background: {{ section.settings.background_color }};
    overflow: visible;
  }

  {{ sec_id }} .pc-testimonial-container {
    max-width: {{ section.settings.max_width }}px;
    width: 98%;
    min-height: 360px;
    height: 360px;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    margin: auto;
  }

  {{ sec_id }} .pc-testimonial-image {
    width: 40%;
    height: 100%;
    float: left;
    position: relative;
    z-index: 200;
    box-shadow: 0px 40px 120px 0px rgba(0,0,0,0.52);
    overflow: visible;
  }

  {{ sec_id }} .pc-testimonial-right {
    width: 60%;
    height: 100%;
    float: right;
    position: relative;
  }

  {{ sec_id }} .pc-testimonial-text {
    width: 60%;
    height: 320px;
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    margin: auto;
    z-index: 100;
    background: {{ section.settings.text_background }};
    box-shadow: 0px 40px 120px 0px rgba(0,0,0,0.52);
  }

  {{ sec_id }} .pc-testimonial-nav {
    width: 140px;
    height: 50px;
    position: absolute;
    bottom: 0;
    left: 50%;
    margin: 0 0 -25px -70px;
    z-index: 1000;
    box-shadow: 0px 7px 24px 3px rgba(0,0,0,0.52);
    display: {{ section.settings.show_nav_buttons | default: 'block' }};
  }

  {{ sec_id }} .pc-testimonial-prev,
  {{ sec_id }} .pc-testimonial-next {
    width: 50%;
    height: 100%;
    color: {{ section.settings.nav_icon_color }};
    background: {{ section.settings.nav_background }};
    font-size: 25px;
    line-height: 200%;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease-in;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  {{ sec_id }} .pc-testimonial-prev {
    float: left;
    border-right: 1px solid {{ section.settings.nav_icon_color }};
  }

  {{ sec_id }} .pc-testimonial-next {
    float: right;
    border-left: 1px solid {{ section.settings.nav_icon_color }};
  }

  {{ sec_id }} .pc-testimonial-prev:hover,
  {{ sec_id }} .pc-testimonial-next:hover {
    color: {{ section.settings.nav_icon_hover_color }};
  }

  {{ sec_id }} .pc-testimonial-circles {
    width: 96px;
    height: 20px;
    position: absolute;
    bottom: 8%;
    left: 50%;
    margin-left: -50px;
    display: {{ section.settings.show_dots | default: 'block' }};
  }

  {{ sec_id }} .pc-testimonial-circle {
    width: 20px;
    height: 100%;
    float: left;
    border-radius: 100%;
    border: 2px solid {{ section.settings.dot_color }};
    margin: 0 6px;
    cursor: pointer;
    transition: all 0.75s cubic-bezier(0.86, 0.3, 0.07, 1);
  }

  {{ sec_id }} .pc-testimonial-circle.active {
    background: {{ section.settings.dot_active_color }};
  }

  {{ sec_id }} .pc-testimonial-center-text {
    width: 100%;
    height: 200px;
    position: absolute;
    top: 20%;
    margin-top: -100px;
    padding: 10px 0;
    overflow: visible;
  }

  {{ sec_id }} .pc-testimonial-quote {
    width: 100%;
    height: 150px;
    position: absolute;
    top: 45px;
    left: 0;
    right: -150px;
    bottom: 0;
    margin: auto;
    font-size: {{ section.settings.quote_font_size }}px;
    color: {{ section.settings.quote_color }};
    padding: 0 25px;
    text-align: center;
    opacity: 0;
    transition: all 2s cubic-bezier(0.86, 0.3, 0.03, 1), opacity 0.7s cubic-bezier(0.86, 0.3, 0.47, 1) 0.3s;
  }

  {{ sec_id }} .pc-testimonial-quote.active {
    right: 0;
    opacity: 1;
  }

  {{ sec_id }} .pc-testimonial-img {
    width: 100%;
    height: 100%;
    position: absolute;
    right: -100%;
    background-position: center !important;
    background-size: cover !important;
    background-repeat: no-repeat !important;
    opacity: 0;
    z-index: 400;
    transition: all 2s cubic-bezier(0.86, 0.3, 0.03, 1), opacity 0.7s cubic-bezier(0.86, 0.3, 0.47, 1) 0.3s;
  }

  {{ sec_id }} .pc-testimonial-img.active {
    right: 0;
    opacity: 1;
    z-index: 500;
  }

  {{ sec_id }} .pc-testimonial-bg {
    width: 100%;
    height: 100%;
    position: absolute;
  }

  {{ sec_id }} .pc-testimonial-slide {
    width: 100%;
    height: 100%;
    position: absolute;
    opacity: 0;
    transition: all 1.5s ease;
  }

  {{ sec_id }} .pc-testimonial-slide.active {
    opacity: 1;
  }

  @media screen and (max-width: 700px) {
    {{ sec_id }} .pc-testimonial-quote {
      font-size: {{ section.settings.mobile_quote_font_size }}px;
    }
  }

  @media screen and (max-width: 580px) {
    {{ sec_id }} .pc-testimonial-container {
      width: 100%;
      height: 100%;
    }

    {{ sec_id }} .pc-testimonial-image {
      width: 220px;
      height: 250px;
      float: left;
      position: absolute;
      top: 50%;
      left: 50%;
      margin-top: -280px;
      margin-left: -110px;
    }

    {{ sec_id }} .pc-testimonial-right {
      width: 100%;
      height: 100%;
    }

    {{ sec_id }} .pc-testimonial-text {
      width: 90%;
      height: 320px;
      top: 150px;
    }

    {{ sec_id }} .pc-testimonial-circles {
      display: none;
    }

    {{ sec_id }} .pc-testimonial-center-text {
      top: 30%;
      padding: 150px 0 !important;
    }
  }

  @media screen and (max-width: 450px) {
    {{ sec_id }} .pc-testimonial-image {
      width: 200px;
      height: 230px;
      margin-top: -250px;
      margin-left: -100px;
    }

    {{ sec_id }} .pc-testimonial-text {
      width: 100%;
    }

    {{ sec_id }} .pc-testimonial-center-text {
      padding: 120px 0 !important;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const sliderElement = document.querySelector('pc-testimonial-slider-{{ last_part }}');
    if (!sliderElement) return;

    const slides = sliderElement.querySelectorAll('.pc-testimonial-img');
    const quotes = sliderElement.querySelectorAll('.pc-testimonial-quote');
    const backgrounds = sliderElement.querySelectorAll('.pc-testimonial-slide');
    const circles = sliderElement.querySelectorAll('.pc-testimonial-circle');
    const prevBtn = sliderElement.querySelector('.pc-testimonial-prev');
    const nextBtn = sliderElement.querySelector('.pc-testimonial-next');
    
    let currentIndex = 0;
    const totalSlides = slides.length;

    function showSlide(index) {
      // Hide all slides
      slides.forEach(slide => slide.classList.remove('active'));
      quotes.forEach(quote => quote.classList.remove('active'));
      backgrounds.forEach(bg => bg.classList.remove('active'));
      circles.forEach(circle => circle.classList.remove('active'));

      // Show current slide
      slides[index].classList.add('active');
      quotes[index].classList.add('active');
      backgrounds[index].classList.add('active');
      circles[index].classList.add('active');

      currentIndex = index;
    }

    function nextSlide() {
      currentIndex = (currentIndex + 1) % totalSlides;
      showSlide(currentIndex);
    }

    function prevSlide() {
      currentIndex = (currentIndex - 1 + totalSlides) % totalSlides;
      showSlide(currentIndex);
    }

    // Initialize first slide
    showSlide(0);

    // Event listeners
    if (nextBtn) nextBtn.addEventListener('click', nextSlide);
    if (prevBtn) prevBtn.addEventListener('click', prevSlide);

    circles.forEach((circle, index) => {
      circle.addEventListener('click', () => showSlide(index));
    });

    // Auto-rotate if enabled
    {% if section.settings.auto_rotate %}
      let rotateInterval = setInterval(nextSlide, {{ section.settings.rotate_interval }}000);
      
      sliderElement.addEventListener('mouseenter', () => {
        clearInterval(rotateInterval);
      });

      sliderElement.addEventListener('mouseleave', () => {
        rotateInterval = setInterval(nextSlide, {{ section.settings.rotate_interval }}000);
      });
    {% endif %}
  });
</script>

{% schema %}
{
  "name": "Testimonial Slider #1",
  "tag": "section",
  "class": "shopify-section",
  "settings": [
    {
      "type": "header",
      "content": "General Settings"
    },
    {
      "type": "range",
      "id": "max_width",
      "label": "Max Width",
      "min": 500,
      "max": 1200,
      "step": 10,
      "unit": "px",
      "default": 700
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#e2e2e2"
    },
    {
      "type": "checkbox",
      "id": "auto_rotate",
      "label": "Auto Rotate Slides",
      "default": false
    },
    {
      "type": "range",
      "id": "rotate_interval",
      "label": "Rotation Interval (seconds)",
      "min": 2,
      "max": 10,
      "step": 1,
      "default": 5,
      "info": "Time between auto slide transitions"
    },
    {
      "type": "checkbox",
      "id": "show_nav_buttons",
      "label": "Show Navigation Buttons",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_dots",
      "label": "Show Navigation Dots",
      "default": true
    },
    {
      "type": "header",
      "content": "Text Settings"
    },
    {
      "type": "color",
      "id": "text_background",
      "label": "Text Background",
      "default": "rgba(255,255,255,0.57)"
    },
    {
      "type": "range",
      "id": "quote_font_size",
      "label": "Quote Font Size (Desktop)",
      "min": 12,
      "max": 36,
      "step": 1,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "mobile_quote_font_size",
      "label": "Quote Font Size (Mobile)",
      "min": 12,
      "max": 24,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
      "type": "color",
      "id": "quote_color",
      "label": "Quote Text Color",
      "default": "#232323"
    },
    {
      "type": "header",
      "content": "Navigation Settings"
    },
    {
      "type": "color",
      "id": "nav_background",
      "label": "Navigation Background",
      "default": "#232323"
    },
    {
      "type": "color",
      "id": "nav_icon_color",
      "label": "Navigation Icon Color",
      "default": "rgba(255,255,255,0.57)"
    },
    {
      "type": "color",
      "id": "nav_icon_hover_color",
      "label": "Navigation Icon Hover Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "dot_color",
      "label": "Dot Color",
      "default": "#232323"
    },
    {
      "type": "color",
      "id": "dot_active_color",
      "label": "Active Dot Color",
      "default": "#232323"
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Person Image"
        },
        {
          "type": "image_picker",
          "id": "background_image",
          "label": "Background Image"
        },
        {
          "type": "richtext",
          "id": "quote",
          "label": "Testimonial Quote",
          "default": "<p>Enter your testimonial quote here</p>"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Testimonial Slider #1",
      "category": "Custom",
      "blocks": [
        {
          "type": "testimonial"
        },
        {
          "type": "testimonial"
        },
        {
          "type": "testimonial"
        }
      ]
    }
  ]
}
{% endschema %}