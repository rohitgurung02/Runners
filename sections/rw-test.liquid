{%- assign sec_id = '#shopify-section-' | append: section.id -%}
{%- assign parts = sec_id | split: '_' -%}
{%- assign last_lower = parts | last -%}
{%- assign last_part = last_lower | downcase -%}

<style>

  {{ sec_id }} .pc-testimonials-section {
    position: relative;
    width: 100%;
    padding-top: {{ section.settings.desktop_padding_top }}px;
    padding-bottom: {{ section.settings.desktop_padding_bottom }}px;
    background-color: {{ section.settings.background_color }};
    overflow: hidden;
  }

  {{ sec_id }} .pc-testimonials__container {
    max-width: {{ section.settings.max_width }}px;
    margin: 0 auto;
  }

  {{ sec_id }} .pc-testimonials__heading {
    font-size: {{ section.settings.heading_font_size }}px;
    color: {{ section.settings.heading_color }};
    text-align: center;
    margin-bottom: {{ section.settings.heading_margin_bottom }}px;
    font-weight: {{ section.settings.heading_font_weight }};
  }

  {{ sec_id }} .pc-testimonials__carousel-wrapper {
    overflow: hidden;
    position: relative;
    width: 100%;
  }

  {{ sec_id }} .pc-testimonials__carousel {
    display: flex;
    position: relative;
    padding: 30px 0;
    transition: transform 0.5s ease;
  }

  {{ sec_id }} .pc-testimonials__slide {
    flex: 0 0 calc(100% / 3);
    min-width: 0;
    padding: 0 15px;
    transition: all 0.3s ease;
    box-sizing: border-box;
  }

  {{ sec_id }} .pc-testimonials__card {
    background: {{ section.settings.card_background }};
    border-radius: {{ section.settings.card_border_radius }}px;
    padding: {{ section.settings.card_padding }}px;
    text-align: center;
    width: 100%;
    height: 100%;
    margin: 0 auto;
    {% if section.settings.card_shadow %}
      box-shadow: 0 8px 30px -7px {{ section.settings.card_shadow_color }};
    {% endif %}
  }

  {{ sec_id }} .pc-testimonials__image {
    width: {{ section.settings.image_size }}px;
    height: {{ section.settings.image_size }}px;
    object-fit: cover;
    border-radius: 50%;
    margin: 0 auto 15px;
    {% if section.settings.image_shadow %}
      box-shadow: 0 8px 20px -4px {{ section.settings.image_shadow_color }};
    {% endif %}
  }

  {{ sec_id }} .pc-testimonials__name {
    font-size: {{ section.settings.name_font_size }}px;
    color: {{ section.settings.name_color }};
    margin-bottom: 5px;
    line-height: 1.3;
  }

  {{ sec_id }} .pc-testimonials__position {
    display: block;
    font-size: {{ section.settings.position_font_size }}px;
    color: {{ section.settings.position_color }};
    font-weight: normal;
  }

  {{ sec_id }} .pc-testimonials__quote {
    font-size: {{ section.settings.quote_font_size }}px;
    color: {{ section.settings.quote_color }};
    font-style: {{ section.settings.quote_font_style }};
    line-height: 1.5;
  }

  {{ sec_id }} .pc-testimonials__nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-top: 20px;
  }

  {{ sec_id }} .pc-testimonials__arrow {
    background: transparent;
    border: none;
    cursor: pointer;
    color: {{ section.settings.arrow_color }};
    padding: 5px;
  }

  {{ sec_id }} .pc-testimonials__dots {
    display: flex;
    gap: 10px;
  }

  {{ sec_id }} .pc-testimonials__dots span {
    display: block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: {{ section.settings.dot_color }};
    border: 2px solid {{ section.settings.dot_active_color }};
    cursor: pointer;
    transition: all 0.3s ease;
  }

  {{ sec_id }} .pc-testimonials__dots span.active {
    background: {{ section.settings.dot_active_color }};
    width: 12px;
    height: 12px;
  }

  @media (max-width: 1024px) {
    {{ sec_id }} .pc-testimonials__slide {
      flex: 0 0 50%;
    }
  }

  @media (max-width: 767px) {
    {{ sec_id }} .pc-testimonials {
      padding-top: {{ section.settings.mobile_padding_top }}px;
      padding-bottom: {{ section.settings.mobile_padding_bottom }}px;
    }

    {{ sec_id }} .pc-testimonials__heading {
      font-size: {{ section.settings.mobile_heading_font_size }}px;
      margin-bottom: {{ section.settings.mobile_heading_margin_bottom }}px;
    }

    {{ sec_id }} .pc-testimonials__slide {
      flex: 0 0 100%;
    }

    {{ sec_id }} .pc-testimonials__name {
      font-size: {{ section.settings.mobile_name_font_size }}px;
    }

    {{ sec_id }} .pc-testimonials__position {
      font-size: {{ section.settings.mobile_position_font_size }}px;
    }

    {{ sec_id }} .pc-testimonials__quote {
      font-size: {{ section.settings.mobile_quote_font_size }}px;
    }
  }
</style>

<div class="pc-testimonials-section">
<pc-testimonials-{{ last_part }} class="pc-testimonials">
  <div class="pc-testimonials__container">
    {%- if section.settings.heading != blank -%}
      <h2 class="pc-testimonials__heading">{{ section.settings.heading }}</h2>
    {%- endif -%}
    
    <div class="pc-testimonials__carousel-wrapper">
      <div class="pc-testimonials__carousel">
        {%- for block in section.blocks -%}
          <div class="pc-testimonials__slide">
            <div class="pc-testimonials__card">
              {%- if block.settings.image != blank -%}
                {{- block.settings.image
                  | image_url: width: block.settings.image.width, height: block.settings.image.height
                  | image_tag: loading: 'lazy', preload: true, alt: block.settings.image.alt, class: 'pc-testimonials__image'
                -}}
              {%- else -%}
                {{ 'product-1' | placeholder_svg_tag: 'pc-testimonials__image' }}
              {%- endif -%}
              
              <div class="pc-testimonials__content">
                {%- if block.settings.name != blank -%}
                  <h3 class="pc-testimonials__name">
                    {{ block.settings.name }}
                    {%- if block.settings.position != blank -%}
                      <span class="pc-testimonials__position">{{ block.settings.position }}</span>
                    {%- endif -%}
                  </h3>
                {%- endif -%}
                
                {%- if block.settings.quote != blank -%}
                  <div class="pc-testimonials__quote">{{ block.settings.quote }}</div>
                {%- endif -%}
              </div>
            </div>
          </div>
        {%- endfor -%}
      </div>
    </div>
    
    <div class="pc-testimonials__nav">
      <button class="pc-testimonials__arrow pc-testimonials__arrow--prev" aria-label="Previous">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>
      <div class="pc-testimonials__dots"></div>
      <button class="pc-testimonials__arrow pc-testimonials__arrow--next" aria-label="Next">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 18l6-6-6-6"/>
        </svg>
      </button>
    </div>
  </div>
</pc-testimonials-{{ last_part }}>
</div>
<script>
  class PcTestimonials{{ last_part | capitalize }} extends HTMLElement {
    constructor() {
      super();
      this.carouselWrapper = this.querySelector('.pc-testimonials__carousel-wrapper');
      this.carousel = this.querySelector('.pc-testimonials__carousel');
      this.slides = this.querySelectorAll('.pc-testimonials__slide');
      this.prevBtn = this.querySelector('.pc-testimonials__arrow--prev');
      this.nextBtn = this.querySelector('.pc-testimonials__arrow--next');
      this.dotsContainer = this.querySelector('.pc-testimonials__dots');
      this.dots = [];
      this.currentIndex = 0;
      this.visibleSlides = 3;
      this.autoPlay = {{ section.settings.auto_play }};
      this.autoPlayInterval = {{ section.settings.auto_play_speed }} * 1000;
      this.autoPlayTimer = null;
      this.isAnimating = false;
      
      this.init();
    }
    
    connectedCallback() {
      this.updateSlides();
      window.addEventListener('resize', this.handleResize.bind(this));
      this.setSlideWidths();
    }
    
    disconnectedCallback() {
      window.removeEventListener('resize', this.handleResize.bind(this));
      if (this.autoPlayTimer) {
        clearInterval(this.autoPlayTimer);
      }
    }
    
    init() {
      this.setVisibleSlides();
      this.createDots();
      this.setupEventListeners();
      
      if (this.autoPlay) {
        this.startAutoPlay();
      }
    }
    
    setVisibleSlides() {
      // Adjust visible slides based on screen size
      if (window.innerWidth <= 1024 && window.innerWidth > 767) {
        this.visibleSlides = 2;
      } else if (window.innerWidth <= 767) {
        this.visibleSlides = 1;
      } else {
        this.visibleSlides = 3;
      }
    }
    
    setSlideWidths() {
      const slideWidth = 100 / this.visibleSlides;
      this.slides.forEach(slide => {
        slide.style.flex = `0 0 ${slideWidth}%`;
      });
    }
    
    createDots() {
      // Clear existing dots
      this.dotsContainer.innerHTML = '';
      this.dots = [];
      
      // Create dots based on number of slides and visible slides
      const dotCount = Math.max(this.slides.length - this.visibleSlides + 1, 1);
      for (let i = 0; i < dotCount; i++) {
        const dot = document.createElement('span');
        dot.addEventListener('click', () => this.goToSlide(i));
        this.dotsContainer.appendChild(dot);
        this.dots.push(dot);
      }
      this.updateDots();
    }
    
    updateDots() {
      this.dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === this.currentIndex);
      });
    }
    
    updateSlides() {
      if (this.isAnimating) return;
      
      this.isAnimating = true;
      
      const slideWidth = 100 / this.visibleSlides;
      this.carousel.style.transition = 'transform 0.5s ease';
      this.carousel.style.transform = `translateX(-${this.currentIndex * slideWidth}%)`;
      
      setTimeout(() => {
        this.isAnimating = false;
      }, 500);
      
      this.updateDots();
    }
    
    goToSlide(index) {
      // Ensure index is within bounds
      const maxIndex = Math.max(this.slides.length - this.visibleSlides, 0);
      this.currentIndex = Math.min(Math.max(index, 0), maxIndex);
      this.updateSlides();
      if (this.autoPlay) {
        this.resetAutoPlay();
      }
    }
    
    nextSlide() {
      if (this.isAnimating) return;
      const maxIndex = Math.max(this.slides.length - this.visibleSlides, 0);
      this.currentIndex = (this.currentIndex + 1) % (maxIndex + 1);
      this.updateSlides();
      if (this.autoPlay) {
        this.resetAutoPlay();
      }
    }
    
    prevSlide() {
      if (this.isAnimating) return;
      const maxIndex = Math.max(this.slides.length - this.visibleSlides, 0);
      this.currentIndex = (this.currentIndex - 1 + (maxIndex + 1)) % (maxIndex + 1);
      this.updateSlides();
      if (this.autoPlay) {
        this.resetAutoPlay();
      }
    }
    
    setupEventListeners() {
      this.prevBtn.addEventListener('click', () => this.prevSlide());
      this.nextBtn.addEventListener('click', () => this.nextSlide());
    }
    
    startAutoPlay() {
      this.autoPlayTimer = setInterval(() => this.nextSlide(), this.autoPlayInterval);
    }
    
    resetAutoPlay() {
      clearInterval(this.autoPlayTimer);
      this.startAutoPlay();
    }
    
    handleResize() {
      const prevVisibleSlides = this.visibleSlides;
      this.setVisibleSlides();
      
      // Only update if visible slides count changed
      if (prevVisibleSlides !== this.visibleSlides) {
        this.setSlideWidths();
        this.createDots();
        this.currentIndex = Math.min(this.currentIndex, Math.max(this.slides.length - this.visibleSlides, 0));
        this.updateSlides();
      }
    }
  }
  
  customElements.define('pc-testimonials-{{ last_part }}', PcTestimonials{{ last_part | capitalize }});
</script>

{% schema %}
{
  "name": "RW - Testimonials #5",
  "class": "shopify-section",
  "settings": [
    {
      "type": "header",
      "content": "Layout Settings"
    },
    {
      "type": "range",
      "id": "max_width",
      "label": "Max Width",
      "min": 500,
      "max": 2000,
      "step": 50,
      "unit": "px",
      "default": 1200
    },
    {
      "type": "header",
      "content": "Heading"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Testimonials Carousel"
    },
    {
      "type": "range",
      "id": "heading_font_size",
      "label": "Heading Font Size (Desktop)",
      "min": 10,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 30
    },
    {
      "type": "range",
      "id": "mobile_heading_font_size",
      "label": "Heading Font Size (Mobile)",
      "min": 10,
      "max": 60,
      "step": 1,
      "unit": "px",
      "default": 24
    },
    {
      "type": "range",
      "id": "heading_margin_bottom",
      "label": "Heading Margin Bottom (Desktop)",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 50
    },
    {
      "type": "range",
      "id": "mobile_heading_margin_bottom",
      "label": "Heading Margin Bottom (Mobile)",
      "min": 0,
      "max": 80,
      "step": 5,
      "unit": "px",
      "default": 30
    },
    {
      "type": "select",
      "id": "heading_font_weight",
      "label": "Heading Font Weight",
      "options": [
        { "value": "400", "label": "Normal" },
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semi Bold" },
        { "value": "700", "label": "Bold" }
      ],
      "default": "600"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#333333"
    },
    {
      "type": "range",
      "id": "desktop_padding_top",
      "label": "Top Padding (Desktop)",
      "min": 0,
      "max": 200,
      "step": 5,
      "unit": "px",
      "default": 50
    },
    {
      "type": "range",
      "id": "desktop_padding_bottom",
      "label": "Bottom Padding (Desktop)",
      "min": 0,
      "max": 200,
      "step": 5,
      "unit": "px",
      "default": 50
    },
    {
      "type": "range",
      "id": "mobile_padding_top",
      "label": "Top Padding (Mobile)",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 30
    },
    {
      "type": "range",
      "id": "mobile_padding_bottom",
      "label": "Bottom Padding (Mobile)",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 30
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#f0f8ff"
    },
    {
      "type": "header",
      "content": "Card Settings"
    },
    {
      "type": "color",
      "id": "card_background",
      "label": "Card Background",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "card_border_radius",
      "label": "Card Border Radius",
      "min": 0,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "card_padding",
      "label": "Card Padding",
      "min": 0,
      "max": 50,
      "step": 5,
      "unit": "px",
      "default": 20
    },
    {
      "type": "checkbox",
      "id": "card_shadow",
      "label": "Enable Card Shadow",
      "default": true
    },
    {
      "type": "color",
      "id": "card_shadow_color",
      "label": "Card Shadow Color",
      "default": "#c9dff0"
    },
    {
      "type": "header",
      "content": "Image Settings"
    },
    {
      "type": "range",
      "id": "image_size",
      "label": "Image Size",
      "min": 50,
      "max": 200,
      "step": 10,
      "unit": "px",
      "default": 100
    },
    {
      "type": "checkbox",
      "id": "image_shadow",
      "label": "Enable Image Shadow",
      "default": true
    },
    {
      "type": "color",
      "id": "image_shadow_color",
      "label": "Image Shadow Color",
      "default": "#95abbb"
    },
    {
      "type": "header",
      "content": "Text Settings"
    },
    {
      "type": "range",
      "id": "name_font_size",
      "label": "Name Font Size (Desktop)",
      "min": 10,
      "max": 50,
      "step": 1,
      "unit": "px",
      "default": 21
    },
    {
      "type": "range",
      "id": "mobile_name_font_size",
      "label": "Name Font Size (Mobile)",
      "min": 10,
      "max": 30,
      "step": 1,
      "unit": "px",
      "default": 18
    },
    {
      "type": "color",
      "id": "name_color",
      "label": "Name Color",
      "default": "#01b0f8"
    },
    {
      "type": "range",
      "id": "position_font_size",
      "label": "Position Font Size (Desktop)",
      "min": 10,
      "max": 30,
      "step": 1,
      "unit": "px",
      "default": 18
    },
    {
      "type": "range",
      "id": "mobile_position_font_size",
      "label": "Position Font Size (Mobile)",
      "min": 10,
      "max": 24,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
      "type": "color",
      "id": "position_color",
      "label": "Position Color",
      "default": "#666666"
    },
    {
      "type": "range",
      "id": "quote_font_size",
      "label": "Quote Font Size (Desktop)",
      "min": 10,
      "max": 30,
      "step": 1,
      "unit": "px",
      "default": 18
    },
    {
      "type": "range",
      "id": "mobile_quote_font_size",
      "label": "Quote Font Size (Mobile)",
      "min": 10,
      "max": 24,
      "step": 1,
      "unit": "px",
      "default": 16
    },
    {
      "type": "color",
      "id": "quote_color",
      "label": "Quote Color",
      "default": "#555555"
    },
    {
      "type": "select",
      "id": "quote_font_style",
      "label": "Quote Font Style",
      "options": [
        { "value": "normal", "label": "Normal" },
        { "value": "italic", "label": "Italic" }
      ],
      "default": "normal"
    },
    {
      "type": "header",
      "content": "Navigation Settings"
    },
    {
      "type": "color",
      "id": "arrow_color",
      "label": "Arrow Color",
      "default": "#01b0f8"
    },
    {
      "type": "color",
      "id": "dot_color",
      "label": "Dot Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "dot_active_color",
      "label": "Active Dot Color",
      "default": "#01b0f8"
    },
    {
      "type": "header",
      "content": "Carousel Settings"
    },
    {
      "type": "checkbox",
      "id": "auto_play",
      "label": "Auto Play",
      "default": true
    },
    {
      "type": "range",
      "id": "auto_play_speed",
      "label": "Auto Play Speed (seconds)",
      "min": 1,
      "max": 10,
      "step": 1,
      "default": 3
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "name",
          "label": "Name",
          "default": "John Doe"
        },
        {
          "type": "text",
          "id": "position",
          "label": "Position",
          "default": "Project Manager"
        },
        {
          "type": "richtext",
          "id": "quote",
          "label": "Quote",
          "default": "<p>\"Nam libero tempore, cum soluta nobis est eligendi optio cumque nihil impedit quo minus id quod maxime placeat\"</p>"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "RW - Testimonials Carousel #5",
      "category": "Custom",
      "blocks": [
        {
          "type": "testimonial",
          "settings": {
            "name": "Ronne Galle",
            "position": "Project Manager",
            "quote": "<p>\"Nam libero tempore, cum soluta nobis est eligendi optio cumque nihil impedit quo minus id quod maxime placeat\"</p>"
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "name": "Missy Limana",
            "position": "Engineer",
            "quote": "<p>\"Nam libero tempore, cum soluta nobis est eligendi optio cumque nihil impedit quo minus id quod maxime placeat\"</p>"
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "name": "Martha Brown",
            "position": "Project Manager",
            "quote": "<p>\"Nam libero tempore, cum soluta nobis est eligendi optio cumque nihil impedit quo minus id quod maxime placeat\"</p>"
          }
        }
      ]
    }
  ]
}
{% endschema %}